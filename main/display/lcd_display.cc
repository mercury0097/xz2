#include "lcd_display.h"
#include "assets/lang_config.h"
#include "gif/lvgl_gif.h"
#include "lvgl_theme.h"
#include "pet_icons.h"
#include "settings.h"

#include <algorithm>
#include <cstring>
#include <esp_err.h>
#include <esp_log.h>
#include <esp_lvgl_port.h>
#include <esp_psram.h>
#include <font_awesome.h>
#include <unordered_map>
#include <vector>

#include "board.h"

#define TAG "LcdDisplay"

LV_FONT_DECLARE(BUILTIN_TEXT_FONT);
LV_FONT_DECLARE(BUILTIN_ICON_FONT);
LV_FONT_DECLARE(font_awesome_30_4);

// Emojiåˆ°å® ç‰©å›¾æ ‡çš„æ˜ å°„è¡¨
static const std::unordered_map<std::string, const lv_image_dsc_t *>
    emoji_to_icon = {
        {"ğŸ±", &cat},          {"ğŸ¶", &dog},          {"ğŸ¹", &hamster},
        {"ğŸ°", &rabbit},       {"ğŸ¦Š", &fox_face},     {"ğŸ»", &bear},
        {"ğŸ¼", &panda_face},   {"ğŸ¨", &koala},        {"ğŸ¯", &tiger},
        {"ğŸ¦", &lion_face},    {"ğŸ§", &penguin},      {"ğŸ¦œ", &parrot},
        {"ğŸ‰", &dragon},       {"ğŸ¦„", &unicorn_face}, {"ğŸ˜", &elephant},
        {"ğŸ¦’", &giraffe_face}, {"ğŸ¦", &rhinoceros},   {"ğŸ¦¥", &sloth},
        {"ğŸº", &wolf}};

void LcdDisplay::InitializeLcdThemes() {
  auto text_font = std::make_shared<LvglBuiltInFont>(&BUILTIN_TEXT_FONT);
  auto icon_font = std::make_shared<LvglBuiltInFont>(&BUILTIN_ICON_FONT);
  auto large_icon_font = std::make_shared<LvglBuiltInFont>(&font_awesome_30_4);

  // light theme - å½©è‰²äº®ä¸½ç‰ˆ
  auto light_theme = new LvglTheme("light");
  light_theme->set_background_color(lv_color_hex(
      0x000000)); // rgb(0, 0, 0) çº¯é»‘è‰²èƒŒæ™¯ï¼ˆé€‚é… Otto æœºå™¨äººçœ¼ç›ï¼‰
  light_theme->set_text_color(
      lv_color_hex(0x2C3E50)); // rgb(44, 62, 80) æ·±è“ç°è‰²æ–‡å­—
  light_theme->set_chat_background_color(
      lv_color_hex(0xE8F5E9)); // rgb(232, 245, 233) æ·¡ç»¿è‰²å¯¹è¯æ¡†èƒŒæ™¯
  light_theme->set_user_bubble_color(
      lv_color_hex(0x4CAF50)); // rgb(76, 175, 80) é²œç»¿è‰²ç”¨æˆ·æ°”æ³¡
  light_theme->set_assistant_bubble_color(
      lv_color_hex(0x64B5F6)); // rgb(100, 181, 246) è“è‰²åŠ©æ‰‹æ°”æ³¡
  light_theme->set_system_bubble_color(
      lv_color_hex(0xFFEB3B)); // rgb(255, 235, 59) é»„è‰²ç³»ç»Ÿæç¤º
  light_theme->set_system_text_color(
      lv_color_hex(0x5D4037)); // rgb(93, 64, 55) æ·±è¤è‰²ç³»ç»Ÿæ–‡å­—
  light_theme->set_border_color(
      lv_color_hex(0x03A9F4)); // rgb(3, 169, 244) è“è‰²è¾¹æ¡†
  light_theme->set_low_battery_color(
      lv_color_hex(0xFF5722)); // rgb(255, 87, 34) æ©™çº¢è‰²ä½ç”µé‡
  light_theme->set_text_font(text_font);
  light_theme->set_icon_font(icon_font);
  light_theme->set_large_icon_font(large_icon_font);

  // dark theme - å½©è‰²ç‚«é…·ç‰ˆ
  auto dark_theme = new LvglTheme("dark");
  dark_theme->set_background_color(lv_color_hex(
      0x000000)); // rgb(0, 0, 0) çº¯é»‘è‰²èƒŒæ™¯ï¼ˆé€‚é… Otto æœºå™¨äººçœ¼ç›ï¼‰
  dark_theme->set_text_color(
      lv_color_hex(0xE0E0E0)); // rgb(224, 224, 224) äº®ç°è‰²æ–‡å­—
  dark_theme->set_chat_background_color(
      lv_color_hex(0x283593)); // rgb(40, 53, 147) è“ç´«è‰²å¯¹è¯æ¡†
  dark_theme->set_user_bubble_color(
      lv_color_hex(0x00E676)); // rgb(0, 230, 118) è§å…‰ç»¿ç”¨æˆ·æ°”æ³¡
  dark_theme->set_assistant_bubble_color(
      lv_color_hex(0x448AFF)); // rgb(68, 138, 255) äº®è“è‰²åŠ©æ‰‹æ°”æ³¡
  dark_theme->set_system_bubble_color(
      lv_color_hex(0xFF6E40)); // rgb(255, 110, 64) æ©™è‰²ç³»ç»Ÿæç¤º
  dark_theme->set_system_text_color(
      lv_color_hex(0xFFFFFF)); // rgb(255, 255, 255) ç™½è‰²ç³»ç»Ÿæ–‡å­—
  dark_theme->set_border_color(
      lv_color_hex(0x00E5FF)); // rgb(0, 229, 255) é’è‰²è¾¹æ¡†
  dark_theme->set_low_battery_color(
      lv_color_hex(0xFF1744)); // rgb(255, 23, 68) é²œçº¢è‰²ä½ç”µé‡
  dark_theme->set_text_font(text_font);
  dark_theme->set_icon_font(icon_font);
  dark_theme->set_large_icon_font(large_icon_font);

  auto &theme_manager = LvglThemeManager::GetInstance();
  theme_manager.RegisterTheme("light", light_theme);
  theme_manager.RegisterTheme("dark", dark_theme);
}

LcdDisplay::LcdDisplay(esp_lcd_panel_io_handle_t panel_io,
                       esp_lcd_panel_handle_t panel, int width, int height)
    : panel_io_(panel_io), panel_(panel) {
  width_ = width;
  height_ = height;

  // Initialize LCD themes
  InitializeLcdThemes();

  // Load theme from settings
  Settings settings("display", false);
  std::string theme_name = settings.GetString("theme", "light");
  current_theme_ = LvglThemeManager::GetInstance().GetTheme(theme_name);

  // Create a timer to hide the preview image
  esp_timer_create_args_t preview_timer_args = {
      .callback =
          [](void *arg) {
            LcdDisplay *display = static_cast<LcdDisplay *>(arg);
            display->SetPreviewImage(nullptr);
          },
      .arg = this,
      .dispatch_method = ESP_TIMER_TASK,
      .name = "preview_timer",
      .skip_unhandled_events = false,
  };
  esp_timer_create(&preview_timer_args, &preview_timer_);
}

SpiLcdDisplay::SpiLcdDisplay(esp_lcd_panel_io_handle_t panel_io,
                             esp_lcd_panel_handle_t panel, int width,
                             int height, int offset_x, int offset_y,
                             bool mirror_x, bool mirror_y, bool swap_xy)
    : LcdDisplay(panel_io, panel, width, height) {

  // draw white
  std::vector<uint16_t> buffer(width_, 0xFFFF);
  for (int y = 0; y < height_; y++) {
    esp_lcd_panel_draw_bitmap(panel_, 0, y, width_, y + 1, buffer.data());
  }

  // Set the display to on
  ESP_LOGI(TAG, "Turning display on");
  ESP_ERROR_CHECK(esp_lcd_panel_disp_on_off(panel_, true));

  ESP_LOGI(TAG, "Initialize LVGL library");
  lv_init();

#if CONFIG_SPIRAM
  // lv image cache, currently only PNG is supported
  size_t psram_size_mb = esp_psram_get_size() / 1024 / 1024;
  if (psram_size_mb >= 8) {
    lv_image_cache_resize(2 * 1024 * 1024, true);
    ESP_LOGI(TAG, "Use 2MB of PSRAM for image cache");
  } else if (psram_size_mb >= 2) {
    lv_image_cache_resize(512 * 1024, true);
    ESP_LOGI(TAG, "Use 512KB of PSRAM for image cache");
  }
#endif

  ESP_LOGI(TAG, "Initialize LVGL port");
  lvgl_port_cfg_t port_cfg = ESP_LVGL_PORT_INIT_CONFIG();
  port_cfg.task_priority = 1;
#if CONFIG_SOC_CPU_CORES_NUM > 1
  port_cfg.task_affinity = 1;
#endif
  lvgl_port_init(&port_cfg);

  ESP_LOGI(TAG, "Adding LCD display");
  const lvgl_port_display_cfg_t display_cfg = {
      .io_handle = panel_io_,
      .panel_handle = panel_,
      .control_handle = nullptr,
      .buffer_size = static_cast<uint32_t>(width_ * 20),
      .double_buffer = false,
      .trans_size = 0,
      .hres = static_cast<uint32_t>(width_),
      .vres = static_cast<uint32_t>(height_),
      .monochrome = false,
      .rotation =
          {
              .swap_xy = swap_xy,
              .mirror_x = mirror_x,
              .mirror_y = mirror_y,
          },
      .color_format = LV_COLOR_FORMAT_RGB565,
      .flags =
          {
              .buff_dma = 1,
              .buff_spiram = 0,
              .sw_rotate = 0,
              .swap_bytes = 1,
              .full_refresh = 0,
              .direct_mode = 0,
          },
  };

  display_ = lvgl_port_add_disp(&display_cfg);
  if (display_ == nullptr) {
    ESP_LOGE(TAG, "Failed to add display");
    return;
  }

  if (offset_x != 0 || offset_y != 0) {
    lv_display_set_offset(display_, offset_x, offset_y);
  }

  SetupUI();
}

// RGB LCDå®ç°
RgbLcdDisplay::RgbLcdDisplay(esp_lcd_panel_io_handle_t panel_io,
                             esp_lcd_panel_handle_t panel, int width,
                             int height, int offset_x, int offset_y,
                             bool mirror_x, bool mirror_y, bool swap_xy)
    : LcdDisplay(panel_io, panel, width, height) {

  // draw white
  std::vector<uint16_t> buffer(width_, 0xFFFF);
  for (int y = 0; y < height_; y++) {
    esp_lcd_panel_draw_bitmap(panel_, 0, y, width_, y + 1, buffer.data());
  }

  ESP_LOGI(TAG, "Initialize LVGL library");
  lv_init();

  ESP_LOGI(TAG, "Initialize LVGL port");
  lvgl_port_cfg_t port_cfg = ESP_LVGL_PORT_INIT_CONFIG();
  port_cfg.task_priority = 1;
  port_cfg.timer_period_ms = 50;
  lvgl_port_init(&port_cfg);

  ESP_LOGI(TAG, "Adding LCD display");
  const lvgl_port_display_cfg_t display_cfg = {
      .io_handle = panel_io_,
      .panel_handle = panel_,
      .buffer_size = static_cast<uint32_t>(width_ * 20),
      .double_buffer = true,
      .hres = static_cast<uint32_t>(width_),
      .vres = static_cast<uint32_t>(height_),
      .rotation =
          {
              .swap_xy = swap_xy,
              .mirror_x = mirror_x,
              .mirror_y = mirror_y,
          },
      .flags =
          {
              .buff_dma = 1,
              .swap_bytes = 0,
              .full_refresh = 1,
              .direct_mode = 1,
          },
  };

  const lvgl_port_display_rgb_cfg_t rgb_cfg = {.flags = {
                                                   .bb_mode = true,
                                                   .avoid_tearing = true,
                                               }};

  display_ = lvgl_port_add_disp_rgb(&display_cfg, &rgb_cfg);
  if (display_ == nullptr) {
    ESP_LOGE(TAG, "Failed to add RGB display");
    return;
  }

  if (offset_x != 0 || offset_y != 0) {
    lv_display_set_offset(display_, offset_x, offset_y);
  }

  SetupUI();
}

MipiLcdDisplay::MipiLcdDisplay(esp_lcd_panel_io_handle_t panel_io,
                               esp_lcd_panel_handle_t panel, int width,
                               int height, int offset_x, int offset_y,
                               bool mirror_x, bool mirror_y, bool swap_xy)
    : LcdDisplay(panel_io, panel, width, height) {

  ESP_LOGI(TAG, "Initialize LVGL library");
  lv_init();

  ESP_LOGI(TAG, "Initialize LVGL port");
  lvgl_port_cfg_t port_cfg = ESP_LVGL_PORT_INIT_CONFIG();
  lvgl_port_init(&port_cfg);

  ESP_LOGI(TAG, "Adding LCD display");
  const lvgl_port_display_cfg_t disp_cfg = {
      .io_handle = panel_io,
      .panel_handle = panel,
      .control_handle = nullptr,
      .buffer_size = static_cast<uint32_t>(width_ * 50),
      .double_buffer = false,
      .hres = static_cast<uint32_t>(width_),
      .vres = static_cast<uint32_t>(height_),
      .monochrome = false,
      /* Rotation values must be same as used in esp_lcd for initial settings of
         the screen */
      .rotation =
          {
              .swap_xy = swap_xy,
              .mirror_x = mirror_x,
              .mirror_y = mirror_y,
          },
      .flags =
          {
              .buff_dma = true,
              .buff_spiram = false,
              .sw_rotate = true,
          },
  };

  const lvgl_port_display_dsi_cfg_t dpi_cfg = {.flags = {
                                                   .avoid_tearing = false,
                                               }};
  display_ = lvgl_port_add_disp_dsi(&disp_cfg, &dpi_cfg);
  if (display_ == nullptr) {
    ESP_LOGE(TAG, "Failed to add display");
    return;
  }

  if (offset_x != 0 || offset_y != 0) {
    lv_display_set_offset(display_, offset_x, offset_y);
  }

  SetupUI();
}

LcdDisplay::~LcdDisplay() {
  SetPreviewImage(nullptr);

  // Clean up GIF controller
  if (gif_controller_) {
    gif_controller_->Stop();
    gif_controller_.reset();
  }

  if (preview_timer_ != nullptr) {
    esp_timer_stop(preview_timer_);
    esp_timer_delete(preview_timer_);
  }

  if (preview_image_ != nullptr) {
    lv_obj_del(preview_image_);
  }
  if (chat_message_label_ != nullptr) {
    lv_obj_del(chat_message_label_);
  }
  if (emoji_label_ != nullptr) {
    lv_obj_del(emoji_label_);
  }
  if (emoji_image_ != nullptr) {
    lv_obj_del(emoji_image_);
  }
  if (emoji_box_ != nullptr) {
    lv_obj_del(emoji_box_);
  }
  if (content_ != nullptr) {
    lv_obj_del(content_);
  }
  if (status_bar_ != nullptr) {
    lv_obj_del(status_bar_);
  }
  if (side_bar_ != nullptr) {
    lv_obj_del(side_bar_);
  }
  if (container_ != nullptr) {
    lv_obj_del(container_);
  }
  if (display_ != nullptr) {
    lv_display_delete(display_);
  }

  if (panel_ != nullptr) {
    esp_lcd_panel_del(panel_);
  }
  if (panel_io_ != nullptr) {
    esp_lcd_panel_io_del(panel_io_);
  }
}

bool LcdDisplay::Lock(int timeout_ms) { return lvgl_port_lock(timeout_ms); }

void LcdDisplay::Unlock() { lvgl_port_unlock(); }

#if CONFIG_USE_WECHAT_MESSAGE_STYLE
void LcdDisplay::SetupUI() {
  DisplayLockGuard lock(this);

  auto lvgl_theme = static_cast<LvglTheme *>(current_theme_);
  auto text_font = lvgl_theme->text_font()->font();
  auto icon_font = lvgl_theme->icon_font()->font();
  auto large_icon_font = lvgl_theme->large_icon_font()->font();

  auto screen = lv_screen_active();
  lv_obj_set_style_text_font(screen, text_font, 0);
  lv_obj_set_style_text_color(screen, lvgl_theme->text_color(), 0);
  lv_obj_set_style_bg_color(screen, lvgl_theme->background_color(), 0);

  /* Container */
  container_ = lv_obj_create(screen);
  lv_obj_set_size(container_, LV_HOR_RES, LV_VER_RES);
  lv_obj_set_style_radius(container_, 0, 0);
  lv_obj_set_flex_flow(container_, LV_FLEX_FLOW_COLUMN);
  lv_obj_set_style_pad_all(container_, 0, 0);
  lv_obj_set_style_border_width(container_, 0, 0);
  lv_obj_set_style_pad_row(container_, 0, 0);
  lv_obj_set_style_bg_color(container_, lvgl_theme->background_color(), 0);
  lv_obj_set_style_border_color(container_, lvgl_theme->border_color(), 0);

  /* Status bar */
  status_bar_ = lv_obj_create(container_);
  lv_obj_set_size(status_bar_, LV_HOR_RES, LV_SIZE_CONTENT);
  lv_obj_set_style_radius(status_bar_, 0, 0);
  lv_obj_set_style_bg_color(status_bar_, lvgl_theme->background_color(), 0);
  lv_obj_set_style_text_color(status_bar_, lvgl_theme->text_color(), 0);

  /* Content - Chat area */
  content_ = lv_obj_create(container_);
  lv_obj_set_style_radius(content_, 0, 0);
  lv_obj_set_width(content_, LV_HOR_RES);
  lv_obj_set_flex_grow(content_, 1);
  lv_obj_set_style_pad_all(content_, lvgl_theme->spacing(4), 0);
  lv_obj_set_style_border_width(content_, 0, 0);
  lv_obj_set_style_bg_color(content_, lvgl_theme->chat_background_color(),
                            0); // Background for chat area

  // Enable scrolling for chat content
  lv_obj_set_scrollbar_mode(content_, LV_SCROLLBAR_MODE_OFF);
  lv_obj_set_scroll_dir(content_, LV_DIR_VER);

  // Create a flex container for chat messages
  lv_obj_set_flex_flow(content_, LV_FLEX_FLOW_COLUMN);
  lv_obj_set_flex_align(content_, LV_FLEX_ALIGN_START, LV_FLEX_ALIGN_START,
                        LV_FLEX_ALIGN_START);
  lv_obj_set_style_pad_row(content_, lvgl_theme->spacing(4),
                           0); // Space between messages

  // We'll create chat messages dynamically in SetChatMessage
  chat_message_label_ = nullptr;

  /* Status bar */
  lv_obj_set_flex_flow(status_bar_, LV_FLEX_FLOW_ROW);
  lv_obj_set_style_pad_all(status_bar_, 0, 0);
  lv_obj_set_style_border_width(status_bar_, 0, 0);
  lv_obj_set_style_pad_column(status_bar_, 0, 0);
  lv_obj_set_style_pad_top(status_bar_, lvgl_theme->spacing(2), 0);
  lv_obj_set_style_pad_bottom(status_bar_, lvgl_theme->spacing(2), 0);
  lv_obj_set_style_pad_left(status_bar_, lvgl_theme->spacing(4), 0);
  lv_obj_set_style_pad_right(status_bar_, lvgl_theme->spacing(4), 0);
  lv_obj_set_scrollbar_mode(status_bar_, LV_SCROLLBAR_MODE_OFF);
  // è®¾ç½®çŠ¶æ€æ çš„å†…å®¹å‚ç›´å±…ä¸­
  lv_obj_set_flex_align(status_bar_, LV_FLEX_ALIGN_SPACE_BETWEEN,
                        LV_FLEX_ALIGN_CENTER, LV_FLEX_ALIGN_CENTER);

  network_label_ = lv_label_create(status_bar_);
  lv_label_set_text(network_label_, "");
  lv_obj_set_style_text_font(network_label_, icon_font, 0);
  lv_obj_set_style_text_color(network_label_, lvgl_theme->text_color(), 0);

  // Pet emoji display - shows current pet icon (å·¦ä¾§æ˜¾ç¤º)
  // ä½¿ç”¨å® ç‰©å›¾ç‰‡æ˜¾ç¤º
  // æš‚æ—¶ç¦ç”¨å® ç‰©å›¾æ ‡æ˜¾ç¤ºï¼ˆå¯æ¢å¤ï¼‰
  pet_emoji_img_ = lv_img_create(status_bar_);
  lv_img_set_src(pet_emoji_img_, &cat);    // é»˜è®¤æ˜¾ç¤ºçŒ«å’ªå›¾æ ‡
  lv_obj_set_size(pet_emoji_img_, 20, 20); // ç¼©å°åˆ°20x20åƒç´ 
  lv_obj_set_style_margin_left(pet_emoji_img_, lvgl_theme->spacing(1), 0);
  lv_obj_set_style_margin_right(pet_emoji_img_, lvgl_theme->spacing(1), 0);
  lv_obj_add_flag(pet_emoji_img_, LV_OBJ_FLAG_HIDDEN);  // éšè—å® ç‰©å›¾æ ‡

  notification_label_ = lv_label_create(status_bar_);
  lv_obj_set_flex_grow(notification_label_, 1);
  lv_obj_set_style_text_align(notification_label_, LV_TEXT_ALIGN_CENTER, 0);
  lv_obj_set_style_text_color(notification_label_, lvgl_theme->text_color(), 0);
  lv_label_set_text(notification_label_, "");
  lv_obj_add_flag(notification_label_, LV_OBJ_FLAG_HIDDEN);

  status_label_ = lv_label_create(status_bar_);
  lv_obj_set_flex_grow(status_label_, 1);
  lv_label_set_long_mode(status_label_, LV_LABEL_LONG_SCROLL_CIRCULAR);
  lv_obj_set_style_text_align(status_label_, LV_TEXT_ALIGN_CENTER, 0);
  lv_obj_set_style_text_color(status_label_, lvgl_theme->text_color(), 0);
  lv_label_set_text(status_label_, Lang::Strings::INITIALIZING);

  mute_label_ = lv_label_create(status_bar_);
  lv_label_set_text(mute_label_, "");
  lv_obj_set_style_text_font(mute_label_, icon_font, 0);
  lv_obj_set_style_text_color(mute_label_, lvgl_theme->text_color(), 0);

  battery_label_ = lv_label_create(status_bar_);
  lv_label_set_text(battery_label_, "");
  lv_obj_set_style_text_font(battery_label_, icon_font, 0);
  lv_obj_set_style_text_color(battery_label_, lvgl_theme->text_color(), 0);
  lv_obj_set_style_margin_left(battery_label_, lvgl_theme->spacing(2),
                               0); // æ·»åŠ å·¦è¾¹è·ï¼Œä¸å‰é¢çš„å…ƒç´ åˆ†éš”

  low_battery_popup_ = lv_obj_create(screen);
  lv_obj_set_scrollbar_mode(low_battery_popup_, LV_SCROLLBAR_MODE_OFF);
  lv_obj_set_size(low_battery_popup_, LV_HOR_RES * 0.9,
                  text_font->line_height * 2);
  lv_obj_align(low_battery_popup_, LV_ALIGN_BOTTOM_MID, 0,
               -lvgl_theme->spacing(4));
  lv_obj_set_style_bg_color(low_battery_popup_, lvgl_theme->low_battery_color(),
                            0);
  lv_obj_set_style_radius(low_battery_popup_, lvgl_theme->spacing(4), 0);
  low_battery_label_ = lv_label_create(low_battery_popup_);
  lv_label_set_text(low_battery_label_, Lang::Strings::BATTERY_NEED_CHARGE);
  lv_obj_set_style_text_color(low_battery_label_, lv_color_white(), 0);
  lv_obj_center(low_battery_label_);
  lv_obj_add_flag(low_battery_popup_, LV_OBJ_FLAG_HIDDEN);

  emoji_image_ = lv_img_create(screen);
  lv_obj_align(emoji_image_, LV_ALIGN_TOP_MID, 0,
               text_font->line_height + lvgl_theme->spacing(8));

  // Display AI logo while booting
  emoji_label_ = lv_label_create(screen);
  lv_obj_center(emoji_label_);
  lv_obj_set_style_text_font(emoji_label_, large_icon_font, 0);
  lv_obj_set_style_text_color(emoji_label_, lvgl_theme->text_color(), 0);
  lv_label_set_text(emoji_label_, FONT_AWESOME_MICROCHIP_AI);
}
#if CONFIG_IDF_TARGET_ESP32P4
#define MAX_MESSAGES 40
#else
#define MAX_MESSAGES 20
#endif
void LcdDisplay::SetChatMessage(const char *role, const char *content) {
  DisplayLockGuard lock(this);
  if (content_ == nullptr) {
    return;
  }

  // æ£€æŸ¥æ¶ˆæ¯æ•°é‡æ˜¯å¦è¶…è¿‡é™åˆ¶
  uint32_t child_count = lv_obj_get_child_cnt(content_);
  if (child_count >= MAX_MESSAGES) {
    // åˆ é™¤æœ€æ—©çš„æ¶ˆæ¯ï¼ˆç¬¬ä¸€ä¸ªå­å¯¹è±¡ï¼‰
    lv_obj_t *first_child = lv_obj_get_child(content_, 0);
    lv_obj_t *last_child = lv_obj_get_child(content_, child_count - 1);
    if (first_child != nullptr) {
      lv_obj_del(first_child);
    }
    // Scroll to the last message immediately
    if (last_child != nullptr) {
      lv_obj_scroll_to_view_recursive(last_child, LV_ANIM_OFF);
    }
  }

  // æŠ˜å ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¦‚æœæ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼Œæ£€æŸ¥æœ€åä¸€ä¸ªæ¶ˆæ¯æ˜¯å¦ä¹Ÿæ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼‰
  if (strcmp(role, "system") == 0) {
    if (child_count > 0) {
      // è·å–æœ€åä¸€ä¸ªæ¶ˆæ¯å®¹å™¨
      lv_obj_t *last_container = lv_obj_get_child(content_, child_count - 1);
      if (last_container != nullptr &&
          lv_obj_get_child_cnt(last_container) > 0) {
        // è·å–å®¹å™¨å†…çš„æ°”æ³¡
        lv_obj_t *last_bubble = lv_obj_get_child(last_container, 0);
        if (last_bubble != nullptr) {
          // æ£€æŸ¥æ°”æ³¡ç±»å‹æ˜¯å¦ä¸ºç³»ç»Ÿæ¶ˆæ¯
          void *bubble_type_ptr = lv_obj_get_user_data(last_bubble);
          if (bubble_type_ptr != nullptr &&
              strcmp((const char *)bubble_type_ptr, "system") == 0) {
            // å¦‚æœæœ€åä¸€ä¸ªæ¶ˆæ¯ä¹Ÿæ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼Œåˆ™åˆ é™¤å®ƒ
            lv_obj_del(last_container);
          }
        }
      }
    }
  } else {
    // éšè—å±…ä¸­æ˜¾ç¤ºçš„ AI logo
    lv_obj_add_flag(emoji_label_, LV_OBJ_FLAG_HIDDEN);
  }

  // é¿å…å‡ºç°ç©ºçš„æ¶ˆæ¯æ¡†
  if (strlen(content) == 0) {
    return;
  }

  auto lvgl_theme = static_cast<LvglTheme *>(current_theme_);
  auto text_font = lvgl_theme->text_font()->font();

  // Create a message bubble
  lv_obj_t *msg_bubble = lv_obj_create(content_);
  lv_obj_set_style_radius(msg_bubble, 8, 0);
  lv_obj_set_scrollbar_mode(msg_bubble, LV_SCROLLBAR_MODE_OFF);
  lv_obj_set_style_border_width(msg_bubble, 0, 0);
  lv_obj_set_style_pad_all(msg_bubble, lvgl_theme->spacing(4), 0);

  // Create the message text
  lv_obj_t *msg_text = lv_label_create(msg_bubble);
  lv_label_set_text(msg_text, content);

  // è®¡ç®—æ–‡æœ¬å®é™…å®½åº¦
  lv_coord_t text_width =
      lv_txt_get_width(content, strlen(content), text_font, 0);

  // è®¡ç®—æ°”æ³¡å®½åº¦
  lv_coord_t max_width = LV_HOR_RES * 85 / 100 - 16; // å±å¹•å®½åº¦çš„85%
  lv_coord_t min_width = 20;
  lv_coord_t bubble_width;

  // ç¡®ä¿æ–‡æœ¬å®½åº¦ä¸å°äºæœ€å°å®½åº¦
  if (text_width < min_width) {
    text_width = min_width;
  }

  // å¦‚æœæ–‡æœ¬å®½åº¦å°äºæœ€å¤§å®½åº¦ï¼Œä½¿ç”¨æ–‡æœ¬å®½åº¦
  if (text_width < max_width) {
    bubble_width = text_width;
  } else {
    bubble_width = max_width;
  }

  // è®¾ç½®æ¶ˆæ¯æ–‡æœ¬çš„å®½åº¦
  lv_obj_set_width(msg_text, bubble_width); // å‡å»padding
  lv_label_set_long_mode(msg_text, LV_LABEL_LONG_WRAP);

  // è®¾ç½®æ°”æ³¡å®½åº¦
  lv_obj_set_width(msg_bubble, bubble_width);
  lv_obj_set_height(msg_bubble, LV_SIZE_CONTENT);

  // Set alignment and style based on message role
  if (strcmp(role, "user") == 0) {
    // User messages are right-aligned with green background
    lv_obj_set_style_bg_color(msg_bubble, lvgl_theme->user_bubble_color(), 0);
    lv_obj_set_style_bg_opa(msg_bubble, LV_OPA_70, 0);
    // Set text color for contrast
    lv_obj_set_style_text_color(msg_text, lvgl_theme->text_color(), 0);

    // è®¾ç½®è‡ªå®šä¹‰å±æ€§æ ‡è®°æ°”æ³¡ç±»å‹
    lv_obj_set_user_data(msg_bubble, (void *)"user");

    // Set appropriate width for content
    lv_obj_set_width(msg_bubble, LV_SIZE_CONTENT);
    lv_obj_set_height(msg_bubble, LV_SIZE_CONTENT);

    // Don't grow
    lv_obj_set_style_flex_grow(msg_bubble, 0, 0);
  } else if (strcmp(role, "assistant") == 0) {
    // Assistant messages are left-aligned with white background
    lv_obj_set_style_bg_color(msg_bubble, lvgl_theme->assistant_bubble_color(),
                              0);
    lv_obj_set_style_bg_opa(msg_bubble, LV_OPA_70, 0);
    // Set text color for contrast
    lv_obj_set_style_text_color(msg_text, lvgl_theme->text_color(), 0);

    // è®¾ç½®è‡ªå®šä¹‰å±æ€§æ ‡è®°æ°”æ³¡ç±»å‹
    lv_obj_set_user_data(msg_bubble, (void *)"assistant");

    // Set appropriate width for content
    lv_obj_set_width(msg_bubble, LV_SIZE_CONTENT);
    lv_obj_set_height(msg_bubble, LV_SIZE_CONTENT);

    // Don't grow
    lv_obj_set_style_flex_grow(msg_bubble, 0, 0);
  } else if (strcmp(role, "system") == 0) {
    // System messages are center-aligned with light gray background
    lv_obj_set_style_bg_color(msg_bubble, lvgl_theme->system_bubble_color(), 0);
    lv_obj_set_style_bg_opa(msg_bubble, LV_OPA_70, 0);
    // Set text color for contrast
    lv_obj_set_style_text_color(msg_text, lvgl_theme->system_text_color(), 0);

    // è®¾ç½®è‡ªå®šä¹‰å±æ€§æ ‡è®°æ°”æ³¡ç±»å‹
    lv_obj_set_user_data(msg_bubble, (void *)"system");

    // Set appropriate width for content
    lv_obj_set_width(msg_bubble, LV_SIZE_CONTENT);
    lv_obj_set_height(msg_bubble, LV_SIZE_CONTENT);

    // Don't grow
    lv_obj_set_style_flex_grow(msg_bubble, 0, 0);
  }

  // Create a full-width container for user messages to ensure right alignment
  if (strcmp(role, "user") == 0) {
    // Create a full-width container
    lv_obj_t *container = lv_obj_create(content_);
    lv_obj_set_width(container, LV_HOR_RES);
    lv_obj_set_height(container, LV_SIZE_CONTENT);

    // Make container transparent and borderless
    lv_obj_set_style_bg_opa(container, LV_OPA_TRANSP, 0);
    lv_obj_set_style_border_width(container, 0, 0);
    lv_obj_set_style_pad_all(container, 0, 0);

    // Move the message bubble into this container
    lv_obj_set_parent(msg_bubble, container);

    // Right align the bubble in the container
    lv_obj_align(msg_bubble, LV_ALIGN_RIGHT_MID, -25, 0);

    // Auto-scroll to this container
    lv_obj_scroll_to_view_recursive(container, LV_ANIM_ON);
  } else if (strcmp(role, "system") == 0) {
    // ä¸ºç³»ç»Ÿæ¶ˆæ¯åˆ›å»ºå…¨å®½å®¹å™¨ä»¥ç¡®ä¿å±…ä¸­å¯¹é½
    lv_obj_t *container = lv_obj_create(content_);
    lv_obj_set_width(container, LV_HOR_RES);
    lv_obj_set_height(container, LV_SIZE_CONTENT);

    // ä½¿å®¹å™¨é€æ˜ä¸”æ— è¾¹æ¡†
    lv_obj_set_style_bg_opa(container, LV_OPA_TRANSP, 0);
    lv_obj_set_style_border_width(container, 0, 0);
    lv_obj_set_style_pad_all(container, 0, 0);

    // å°†æ¶ˆæ¯æ°”æ³¡ç§»å…¥æ­¤å®¹å™¨
    lv_obj_set_parent(msg_bubble, container);

    // å°†æ°”æ³¡å±…ä¸­å¯¹é½åœ¨å®¹å™¨ä¸­
    lv_obj_align(msg_bubble, LV_ALIGN_CENTER, 0, 0);

    // è‡ªåŠ¨æ»šåŠ¨åº•éƒ¨
    lv_obj_scroll_to_view_recursive(container, LV_ANIM_ON);
  } else {
    // For assistant messages
    // Left align assistant messages
    lv_obj_align(msg_bubble, LV_ALIGN_LEFT_MID, 0, 0);

    // Auto-scroll to the message bubble
    lv_obj_scroll_to_view_recursive(msg_bubble, LV_ANIM_ON);
  }

  // Store reference to the latest message label
  chat_message_label_ = msg_text;
}

void LcdDisplay::SetPreviewImage(std::unique_ptr<LvglImage> image) {
  DisplayLockGuard lock(this);
  if (content_ == nullptr) {
    return;
  }

  if (image == nullptr) {
    return;
  }

  auto lvgl_theme = static_cast<LvglTheme *>(current_theme_);
  // Create a message bubble for image preview
  lv_obj_t *img_bubble = lv_obj_create(content_);
  lv_obj_set_style_radius(img_bubble, 8, 0);
  lv_obj_set_scrollbar_mode(img_bubble, LV_SCROLLBAR_MODE_OFF);
  lv_obj_set_style_border_width(img_bubble, 0, 0);
  lv_obj_set_style_pad_all(img_bubble, lvgl_theme->spacing(4), 0);

  // Set image bubble background color (similar to system message)
  lv_obj_set_style_bg_color(img_bubble, lvgl_theme->assistant_bubble_color(),
                            0);
  lv_obj_set_style_bg_opa(img_bubble, LV_OPA_70, 0);

  // è®¾ç½®è‡ªå®šä¹‰å±æ€§æ ‡è®°æ°”æ³¡ç±»å‹
  lv_obj_set_user_data(img_bubble, (void *)"image");

  // Create the image object inside the bubble
  lv_obj_t *preview_image = lv_image_create(img_bubble);

  // Calculate appropriate size for the image
  lv_coord_t max_width = LV_HOR_RES * 70 / 100;  // 70% of screen width
  lv_coord_t max_height = LV_VER_RES * 50 / 100; // 50% of screen height

  // Calculate zoom factor to fit within maximum dimensions
  auto img_dsc = image->image_dsc();
  lv_coord_t img_width = img_dsc->header.w;
  lv_coord_t img_height = img_dsc->header.h;
  if (img_width == 0 || img_height == 0) {
    img_width = max_width;
    img_height = max_height;
    ESP_LOGW(TAG,
             "Invalid image dimensions: %ld x %ld, using default dimensions: "
             "%ld x %ld",
             img_width, img_height, max_width, max_height);
  }

  lv_coord_t zoom_w = (max_width * 256) / img_width;
  lv_coord_t zoom_h = (max_height * 256) / img_height;
  lv_coord_t zoom = (zoom_w < zoom_h) ? zoom_w : zoom_h;

  // Ensure zoom doesn't exceed 256 (100%)
  if (zoom > 256)
    zoom = 256;

  // Set image properties
  lv_image_set_src(preview_image, img_dsc);
  lv_image_set_scale(preview_image, zoom);

  // Add event handler to clean up LvglImage when image is deleted
  // We need to transfer ownership of the unique_ptr to the event callback
  LvglImage *raw_image = image.release(); // é‡Šæ”¾æ™ºèƒ½æŒ‡é’ˆçš„æ‰€æœ‰æƒ
  lv_obj_add_event_cb(
      preview_image,
      [](lv_event_t *e) {
        LvglImage *img = (LvglImage *)lv_event_get_user_data(e);
        if (img != nullptr) {
          delete img; // é€šè¿‡åˆ é™¤ LvglImage å¯¹è±¡æ¥æ­£ç¡®é‡Šæ”¾å†…å­˜
        }
      },
      LV_EVENT_DELETE, (void *)raw_image);

  // Calculate actual scaled image dimensions
  lv_coord_t scaled_width = (img_width * zoom) / 256;
  lv_coord_t scaled_height = (img_height * zoom) / 256;

  // Set bubble size to be 16 pixels larger than the image (8 pixels on each
  // side)
  lv_obj_set_width(img_bubble, scaled_width + 16);
  lv_obj_set_height(img_bubble, scaled_height + 16);

  // Don't grow in flex layout
  lv_obj_set_style_flex_grow(img_bubble, 0, 0);

  // Center the image within the bubble
  lv_obj_center(preview_image);

  // Left align the image bubble like assistant messages
  lv_obj_align(img_bubble, LV_ALIGN_LEFT_MID, 0, 0);

  // Auto-scroll to the image bubble
  lv_obj_scroll_to_view_recursive(img_bubble, LV_ANIM_ON);
}
#else
void LcdDisplay::SetupUI() {
  DisplayLockGuard lock(this);
  LvglTheme *lvgl_theme = static_cast<LvglTheme *>(current_theme_);
  auto text_font = lvgl_theme->text_font()->font();
  auto icon_font = lvgl_theme->icon_font()->font();
  auto large_icon_font = lvgl_theme->large_icon_font()->font();

  auto screen = lv_screen_active();
  lv_obj_set_style_text_font(screen, text_font, 0);
  lv_obj_set_style_text_color(screen, lvgl_theme->text_color(), 0);
  lv_obj_set_style_bg_color(screen, lvgl_theme->background_color(), 0);

  /* Container */
  container_ = lv_obj_create(screen);
  lv_obj_set_size(container_, LV_HOR_RES, LV_VER_RES);
  lv_obj_set_style_radius(container_, 0, 0);
  lv_obj_set_flex_flow(container_, LV_FLEX_FLOW_COLUMN);
  lv_obj_set_style_pad_all(container_, 0, 0);
  lv_obj_set_style_border_width(container_, 0, 0);
  lv_obj_set_style_pad_row(container_, 0, 0);
  lv_obj_set_style_bg_color(container_, lvgl_theme->background_color(), 0);
  lv_obj_set_style_border_color(container_, lvgl_theme->border_color(), 0);

  /* Status bar */
  status_bar_ = lv_obj_create(container_);
  lv_obj_set_size(status_bar_, LV_HOR_RES, LV_SIZE_CONTENT);
  lv_obj_set_style_radius(status_bar_, 0, 0);
  lv_obj_set_style_bg_color(status_bar_, lvgl_theme->background_color(), 0);
  lv_obj_set_style_text_color(status_bar_, lvgl_theme->text_color(), 0);
  lv_obj_set_flex_flow(status_bar_, LV_FLEX_FLOW_ROW);
  lv_obj_set_style_pad_top(status_bar_, lvgl_theme->spacing(2), 0);
  lv_obj_set_style_pad_bottom(status_bar_, lvgl_theme->spacing(2), 0);
  lv_obj_set_style_pad_left(status_bar_, lvgl_theme->spacing(4), 0);
  lv_obj_set_style_pad_right(status_bar_, lvgl_theme->spacing(4), 0);
  lv_obj_set_style_border_width(status_bar_, 0, 0);
  lv_obj_set_style_pad_column(status_bar_, 0, 0);

  /* Content */
  content_ = lv_obj_create(container_);
  lv_obj_set_scrollbar_mode(content_, LV_SCROLLBAR_MODE_OFF);
  lv_obj_set_style_radius(content_, 0, 0);
  lv_obj_set_width(content_, LV_HOR_RES);
  lv_obj_set_flex_grow(content_, 1);
  lv_obj_set_style_pad_all(content_, 0, 0);
  lv_obj_set_style_border_width(content_, 0, 0);
  lv_obj_set_style_bg_color(content_, lvgl_theme->chat_background_color(), 0);

  lv_obj_set_flex_flow(content_, LV_FLEX_FLOW_COLUMN); // å‚ç›´å¸ƒå±€ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰
  lv_obj_set_flex_align(content_, LV_FLEX_ALIGN_CENTER, LV_FLEX_ALIGN_CENTER,
                        LV_FLEX_ALIGN_SPACE_EVENLY); // å­å¯¹è±¡å±…ä¸­å¯¹é½ï¼Œç­‰è·åˆ†å¸ƒ

  emoji_box_ = lv_obj_create(content_);
  lv_obj_set_size(emoji_box_, LV_SIZE_CONTENT, LV_SIZE_CONTENT);
  lv_obj_set_style_bg_opa(emoji_box_, LV_OPA_TRANSP, 0);
  lv_obj_set_style_pad_all(emoji_box_, 0, 0);
  lv_obj_set_style_border_width(emoji_box_, 0, 0);

  emoji_label_ = lv_label_create(emoji_box_);
  lv_obj_set_style_text_font(emoji_label_, large_icon_font, 0);
  lv_obj_set_style_text_color(emoji_label_, lvgl_theme->text_color(), 0);
  lv_label_set_text(emoji_label_, FONT_AWESOME_MICROCHIP_AI);

  emoji_image_ = lv_img_create(emoji_box_);
  lv_obj_center(emoji_image_);
  lv_obj_add_flag(emoji_image_, LV_OBJ_FLAG_HIDDEN);

  preview_image_ = lv_image_create(content_);
  lv_obj_set_size(preview_image_, width_ / 2, height_ / 2);
  lv_obj_align(preview_image_, LV_ALIGN_CENTER, 0, 0);
  lv_obj_add_flag(preview_image_, LV_OBJ_FLAG_HIDDEN);

  chat_message_label_ = lv_label_create(content_);
  lv_label_set_text(chat_message_label_, "");
  lv_obj_set_width(chat_message_label_,
                   width_ * 0.9); // é™åˆ¶å®½åº¦ä¸ºå±å¹•å®½åº¦çš„ 90%
  lv_label_set_long_mode(chat_message_label_,
                         LV_LABEL_LONG_WRAP); // è®¾ç½®ä¸ºè‡ªåŠ¨æ¢è¡Œæ¨¡å¼
  lv_obj_set_style_text_align(chat_message_label_, LV_TEXT_ALIGN_CENTER,
                              0); // è®¾ç½®æ–‡æœ¬å±…ä¸­å¯¹é½
  lv_obj_set_style_text_color(chat_message_label_, lvgl_theme->text_color(), 0);

  /* Status bar */
  network_label_ = lv_label_create(status_bar_);
  lv_label_set_text(network_label_, "");
  lv_obj_set_style_text_font(network_label_, icon_font, 0);
  lv_obj_set_style_text_color(network_label_, lvgl_theme->text_color(), 0);

  notification_label_ = lv_label_create(status_bar_);
  lv_obj_set_flex_grow(notification_label_, 1);
  lv_obj_set_style_text_align(notification_label_, LV_TEXT_ALIGN_CENTER, 0);
  lv_obj_set_style_text_color(notification_label_, lvgl_theme->text_color(), 0);
  lv_label_set_text(notification_label_, "");
  lv_obj_add_flag(notification_label_, LV_OBJ_FLAG_HIDDEN);

  status_label_ = lv_label_create(status_bar_);
  lv_obj_set_flex_grow(status_label_, 1);
  lv_label_set_long_mode(status_label_, LV_LABEL_LONG_SCROLL_CIRCULAR);
  lv_obj_set_style_text_align(status_label_, LV_TEXT_ALIGN_CENTER, 0);
  lv_obj_set_style_text_color(status_label_, lvgl_theme->text_color(), 0);
  lv_label_set_text(status_label_, Lang::Strings::INITIALIZING);

  mute_label_ = lv_label_create(status_bar_);
  lv_label_set_text(mute_label_, "");
  lv_obj_set_style_text_font(mute_label_, icon_font, 0);
  lv_obj_set_style_text_color(mute_label_, lvgl_theme->text_color(), 0);

  battery_label_ = lv_label_create(status_bar_);
  lv_label_set_text(battery_label_, "");
  lv_obj_set_style_text_font(battery_label_, icon_font, 0);
  lv_obj_set_style_text_color(battery_label_, lvgl_theme->text_color(), 0);

  // Pet emoji display - shows current pet emoji
  // æš‚æ—¶ç¦ç”¨å® ç‰©å›¾æ ‡æ˜¾ç¤ºï¼ˆå¯æ¢å¤ï¼‰
  pet_emoji_img_ = lv_img_create(status_bar_);
  lv_img_set_src(pet_emoji_img_, &cat);    // é»˜è®¤æ˜¾ç¤ºçŒ«å’ªå›¾æ ‡
  lv_obj_set_size(pet_emoji_img_, 20, 20); // ç¼©å°åˆ°20x20åƒç´ 
  lv_obj_set_style_margin_left(pet_emoji_img_, lvgl_theme->spacing(1), 0);
  lv_obj_add_flag(pet_emoji_img_, LV_OBJ_FLAG_HIDDEN);  // éšè—å® ç‰©å›¾æ ‡

  low_battery_popup_ = lv_obj_create(screen);
  lv_obj_set_scrollbar_mode(low_battery_popup_, LV_SCROLLBAR_MODE_OFF);
  lv_obj_set_size(low_battery_popup_, LV_HOR_RES * 0.9,
                  text_font->line_height * 2);
  lv_obj_align(low_battery_popup_, LV_ALIGN_BOTTOM_MID, 0,
               -lvgl_theme->spacing(4));
  lv_obj_set_style_bg_color(low_battery_popup_, lvgl_theme->low_battery_color(),
                            0);
  lv_obj_set_style_radius(low_battery_popup_, lvgl_theme->spacing(4), 0);

  low_battery_label_ = lv_label_create(low_battery_popup_);
  lv_label_set_text(low_battery_label_, Lang::Strings::BATTERY_NEED_CHARGE);
  lv_obj_set_style_text_color(low_battery_label_, lv_color_white(), 0);
  lv_obj_center(low_battery_label_);
  lv_obj_add_flag(low_battery_popup_, LV_OBJ_FLAG_HIDDEN);
}

void LcdDisplay::SetPreviewImage(std::unique_ptr<LvglImage> image) {
  DisplayLockGuard lock(this);
  if (preview_image_ == nullptr) {
    ESP_LOGE(TAG, "Preview image is not initialized");
    return;
  }

  if (image == nullptr) {
    esp_timer_stop(preview_timer_);
    lv_obj_remove_flag(emoji_box_, LV_OBJ_FLAG_HIDDEN);
    lv_obj_add_flag(preview_image_, LV_OBJ_FLAG_HIDDEN);
    preview_image_cached_.reset();
    if (gif_controller_) {
      gif_controller_->Start();
    }
    return;
  }

  preview_image_cached_ = std::move(image);
  auto img_dsc = preview_image_cached_->image_dsc();
  // è®¾ç½®å›¾ç‰‡æºå¹¶æ˜¾ç¤ºé¢„è§ˆå›¾ç‰‡
  lv_image_set_src(preview_image_, img_dsc);
  if (img_dsc->header.w > 0 && img_dsc->header.h > 0) {
    // zoom factor 0.5
    lv_image_set_scale(preview_image_, 128 * width_ / img_dsc->header.w);
  }

  // Hide emoji_box_
  if (gif_controller_) {
    gif_controller_->Stop();
  }
  lv_obj_add_flag(emoji_box_, LV_OBJ_FLAG_HIDDEN);
  lv_obj_remove_flag(preview_image_, LV_OBJ_FLAG_HIDDEN);
  esp_timer_stop(preview_timer_);
  ESP_ERROR_CHECK(
      esp_timer_start_once(preview_timer_, PREVIEW_IMAGE_DURATION_MS * 1000));
}

void LcdDisplay::SetChatMessage(const char *role, const char *content) {
  DisplayLockGuard lock(this);
  if (chat_message_label_ == nullptr) {
    return;
  }
  lv_label_set_text(chat_message_label_, content);
}
#endif

void LcdDisplay::SetEmotion(const char *emotion) {
  // Stop any running GIF animation
  if (gif_controller_) {
    DisplayLockGuard lock(this);
    gif_controller_->Stop();
    gif_controller_.reset();
  }

  if (emoji_image_ == nullptr) {
    return;
  }

  auto emoji_collection =
      static_cast<LvglTheme *>(current_theme_)->emoji_collection();
  auto image = emoji_collection != nullptr
                   ? emoji_collection->GetEmojiImage(emotion)
                   : nullptr;
  if (image == nullptr) {
    const char *utf8 = font_awesome_get_utf8(emotion);
    if (utf8 != nullptr && emoji_label_ != nullptr) {
      DisplayLockGuard lock(this);
      lv_label_set_text(emoji_label_, utf8);
      lv_obj_add_flag(emoji_image_, LV_OBJ_FLAG_HIDDEN);
      lv_obj_remove_flag(emoji_label_, LV_OBJ_FLAG_HIDDEN);
    }
    return;
  }

  DisplayLockGuard lock(this);
  if (image->IsGif()) {
    // Create new GIF controller
    gif_controller_ = std::make_unique<LvglGif>(image->image_dsc());

    if (gif_controller_->IsLoaded()) {
      // Set up frame update callback
      gif_controller_->SetFrameCallback([this]() {
        lv_image_set_src(emoji_image_, gif_controller_->image_dsc());
      });

      // Set initial frame and start animation
      lv_image_set_src(emoji_image_, gif_controller_->image_dsc());
      gif_controller_->Start();

      // Show GIF, hide others
      lv_obj_add_flag(emoji_label_, LV_OBJ_FLAG_HIDDEN);
      lv_obj_remove_flag(emoji_image_, LV_OBJ_FLAG_HIDDEN);
    } else {
      ESP_LOGE(TAG, "Failed to load GIF for emotion: %s", emotion);
      gif_controller_.reset();
    }
  } else {
    lv_image_set_src(emoji_image_, image->image_dsc());
    lv_obj_add_flag(emoji_label_, LV_OBJ_FLAG_HIDDEN);
    lv_obj_remove_flag(emoji_image_, LV_OBJ_FLAG_HIDDEN);
  }

#if CONFIG_USE_WECHAT_MESSAGE_STYLE
  // Wechat message styleä¸­ï¼Œå¦‚æœemotionæ˜¯neutralï¼Œåˆ™ä¸æ˜¾ç¤º
  uint32_t child_count = lv_obj_get_child_cnt(content_);
  if (strcmp(emotion, "neutral") == 0 && child_count > 0) {
    // Stop GIF animation if running
    if (gif_controller_) {
      gif_controller_->Stop();
      gif_controller_.reset();
    }

    lv_obj_add_flag(emoji_image_, LV_OBJ_FLAG_HIDDEN);
    lv_obj_add_flag(emoji_label_, LV_OBJ_FLAG_HIDDEN);
  }
#endif
}

void LcdDisplay::SetPetEmoji(const char *emoji) {
  // æš‚æ—¶ç¦ç”¨å® ç‰©å›¾æ ‡åŠŸèƒ½ï¼ˆå¯æ¢å¤ï¼‰
  // ç›´æ¥è¿”å›ï¼Œä¸æ˜¾ç¤ºä»»ä½•å® ç‰©å›¾æ ‡
  return;

#if 0  // åŸå§‹ä»£ç ä¿ç•™ï¼Œæ–¹ä¾¿ä»¥åæ¢å¤
  if (pet_emoji_img_ == nullptr || emoji == nullptr) {
    ESP_LOGW(TAG, "SetPetEmoji called with null parameter");
    return;
  }

  DisplayLockGuard lock(this);

  // æŸ¥æ‰¾å¯¹åº”çš„å® ç‰©å›¾æ ‡
  std::string emoji_str(emoji);
  ESP_LOGI(TAG, "SetPetEmoji called with: '%s' (len=%d)", emoji,
           emoji_str.length());

  auto it = emoji_to_icon.find(emoji_str);

  if (it != emoji_to_icon.end()) {
    // æ‰¾åˆ°å¯¹åº”çš„å›¾æ ‡ï¼Œè®¾ç½®å®ƒ
    lv_img_set_src(pet_emoji_img_, it->second);
    lv_obj_clear_flag(pet_emoji_img_, LV_OBJ_FLAG_HIDDEN);
    ESP_LOGI(TAG, "âœ… Set pet icon for emoji: %s", emoji);
  } else {
    // æœªæ‰¾åˆ°å¯¹åº”å›¾æ ‡ï¼Œä½¿ç”¨é»˜è®¤çŒ«å’ªå›¾æ ‡
    lv_img_set_src(pet_emoji_img_, &cat);
    lv_obj_clear_flag(pet_emoji_img_, LV_OBJ_FLAG_HIDDEN);
    ESP_LOGW(TAG,
             "âŒ No icon found for emoji: '%s' (len=%d), using default cat",
             emoji, emoji_str.length());
    // æ‰“å°åå…­è¿›åˆ¶å¸®åŠ©è°ƒè¯•
    ESP_LOGW(TAG, "Emoji bytes:");
    for (size_t i = 0; i < emoji_str.length() && i < 16; i++) {
      ESP_LOGW(TAG, "  [%d] = 0x%02X", i, (unsigned char)emoji_str[i]);
    }
  }
#endif
}

void LcdDisplay::SetTheme(Theme *theme) {
  DisplayLockGuard lock(this);

  auto lvgl_theme = static_cast<LvglTheme *>(theme);

  // Get the active screen
  lv_obj_t *screen = lv_screen_active();

  // Set font
  auto text_font = lvgl_theme->text_font()->font();
  auto icon_font = lvgl_theme->icon_font()->font();
  auto large_icon_font = lvgl_theme->large_icon_font()->font();

  if (text_font->line_height >= 40) {
    lv_obj_set_style_text_font(mute_label_, large_icon_font, 0);
    lv_obj_set_style_text_font(battery_label_, large_icon_font, 0);
    lv_obj_set_style_text_font(network_label_, large_icon_font, 0);
  } else {
    lv_obj_set_style_text_font(mute_label_, icon_font, 0);
    lv_obj_set_style_text_font(battery_label_, icon_font, 0);
    lv_obj_set_style_text_font(network_label_, icon_font, 0);
  }

  // Set parent text color
  lv_obj_set_style_text_font(screen, text_font, 0);
  lv_obj_set_style_text_color(screen, lvgl_theme->text_color(), 0);

  // Set background image
  if (lvgl_theme->background_image() != nullptr) {
    lv_obj_set_style_bg_image_src(
        container_, lvgl_theme->background_image()->image_dsc(), 0);
  } else {
    lv_obj_set_style_bg_image_src(container_, nullptr, 0);
    lv_obj_set_style_bg_color(container_, lvgl_theme->background_color(), 0);
  }

  // Update status bar background color with 50% opacity
  lv_obj_set_style_bg_opa(status_bar_, LV_OPA_50, 0);
  lv_obj_set_style_bg_color(status_bar_, lvgl_theme->background_color(), 0);

  // Update status bar elements
  lv_obj_set_style_text_color(network_label_, lvgl_theme->text_color(), 0);
  lv_obj_set_style_text_color(status_label_, lvgl_theme->text_color(), 0);
  lv_obj_set_style_text_color(notification_label_, lvgl_theme->text_color(), 0);
  lv_obj_set_style_text_color(mute_label_, lvgl_theme->text_color(), 0);
  lv_obj_set_style_text_color(battery_label_, lvgl_theme->text_color(), 0);
  lv_obj_set_style_text_color(emoji_label_, lvgl_theme->text_color(), 0);

  // Set content background opacity
  lv_obj_set_style_bg_opa(content_, LV_OPA_TRANSP, 0);

  // If we have the chat message style, update all message bubbles
#if CONFIG_USE_WECHAT_MESSAGE_STYLE
  // Iterate through all children of content (message containers or bubbles)
  uint32_t child_count = lv_obj_get_child_cnt(content_);
  for (uint32_t i = 0; i < child_count; i++) {
    lv_obj_t *obj = lv_obj_get_child(content_, i);
    if (obj == nullptr)
      continue;

    lv_obj_t *bubble = nullptr;

    // æ£€æŸ¥è¿™ä¸ªå¯¹è±¡æ˜¯å®¹å™¨è¿˜æ˜¯æ°”æ³¡
    // å¦‚æœæ˜¯å®¹å™¨ï¼ˆç”¨æˆ·æˆ–ç³»ç»Ÿæ¶ˆæ¯ï¼‰ï¼Œåˆ™è·å–å…¶å­å¯¹è±¡ä½œä¸ºæ°”æ³¡
    // å¦‚æœæ˜¯æ°”æ³¡ï¼ˆåŠ©æ‰‹æ¶ˆæ¯ï¼‰ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
    if (lv_obj_get_child_cnt(obj) > 0) {
      // å¯èƒ½æ˜¯å®¹å™¨ï¼Œæ£€æŸ¥å®ƒæ˜¯å¦ä¸ºç”¨æˆ·æˆ–ç³»ç»Ÿæ¶ˆæ¯å®¹å™¨
      // ç”¨æˆ·å’Œç³»ç»Ÿæ¶ˆæ¯å®¹å™¨æ˜¯é€æ˜çš„
      lv_opa_t bg_opa = lv_obj_get_style_bg_opa(obj, 0);
      if (bg_opa == LV_OPA_TRANSP) {
        // è¿™æ˜¯ç”¨æˆ·æˆ–ç³»ç»Ÿæ¶ˆæ¯çš„å®¹å™¨
        bubble = lv_obj_get_child(obj, 0);
      } else {
        // è¿™å¯èƒ½æ˜¯åŠ©æ‰‹æ¶ˆæ¯çš„æ°”æ³¡è‡ªèº«
        bubble = obj;
      }
    } else {
      // æ²¡æœ‰å­å…ƒç´ ï¼Œå¯èƒ½æ˜¯å…¶ä»–UIå…ƒç´ ï¼Œè·³è¿‡
      continue;
    }

    if (bubble == nullptr)
      continue;

    // ä½¿ç”¨ä¿å­˜çš„ç”¨æˆ·æ•°æ®æ¥è¯†åˆ«æ°”æ³¡ç±»å‹
    void *bubble_type_ptr = lv_obj_get_user_data(bubble);
    if (bubble_type_ptr != nullptr) {
      const char *bubble_type = static_cast<const char *>(bubble_type_ptr);

      // æ ¹æ®æ°”æ³¡ç±»å‹åº”ç”¨æ­£ç¡®çš„é¢œè‰²
      if (strcmp(bubble_type, "user") == 0) {
        lv_obj_set_style_bg_color(bubble, lvgl_theme->user_bubble_color(), 0);
      } else if (strcmp(bubble_type, "assistant") == 0) {
        lv_obj_set_style_bg_color(bubble, lvgl_theme->assistant_bubble_color(),
                                  0);
      } else if (strcmp(bubble_type, "system") == 0) {
        lv_obj_set_style_bg_color(bubble, lvgl_theme->system_bubble_color(), 0);
      } else if (strcmp(bubble_type, "image") == 0) {
        lv_obj_set_style_bg_color(bubble, lvgl_theme->system_bubble_color(), 0);
      }

      // Update border color
      lv_obj_set_style_border_color(bubble, lvgl_theme->border_color(), 0);

      // Update text color for the message
      if (lv_obj_get_child_cnt(bubble) > 0) {
        lv_obj_t *text = lv_obj_get_child(bubble, 0);
        if (text != nullptr) {
          // æ ¹æ®æ°”æ³¡ç±»å‹è®¾ç½®æ–‡æœ¬é¢œè‰²
          if (strcmp(bubble_type, "system") == 0) {
            lv_obj_set_style_text_color(text, lvgl_theme->system_text_color(),
                                        0);
          } else {
            lv_obj_set_style_text_color(text, lvgl_theme->text_color(), 0);
          }
        }
      }
    } else {
      ESP_LOGW(TAG, "child[%lu] Bubble type is not found", i);
    }
  }
#else
  // Simple UI mode - just update the main chat message
  if (chat_message_label_ != nullptr) {
    lv_obj_set_style_text_color(chat_message_label_, lvgl_theme->text_color(),
                                0);
  }

  if (emoji_label_ != nullptr) {
    lv_obj_set_style_text_color(emoji_label_, lvgl_theme->text_color(), 0);
  }
#endif

  // Update low battery popup
  lv_obj_set_style_bg_color(low_battery_popup_, lvgl_theme->low_battery_color(),
                            0);

  // No errors occurred. Save theme to settings
  Display::SetTheme(lvgl_theme);
}
