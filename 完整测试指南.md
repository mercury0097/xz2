# 完整测试指南 - 自适应学习 + 宠物系统

## 📋 测试前准备

### 1. 编译并烧录固件
```bash
cd /Users/machenyang/Desktop/xiaozhi-esp32-main
idf.py build flash monitor
```

### 2. 等待设备启动成功
观察日志出现：
```
I (xxx) Pet: ✅ Pet system started successfully
I (xxx) Application: STATE: idle
I (xxx) MQTT: Connected to endpoint
```

✅ 看到这些日志，说明设备启动成功，可以开始测试了。

---

## 🧪 测试 1：学习数据持久化（最重要）

### 目的
验证学习数据在重启后不会丢失。

### 步骤

#### Step 1.1：第一次对话
```
你："你好小智"
AI："你好..."

你："今天天气怎么样？"
AI："今天成都..."
```

#### Step 1.2：观察学习日志
```
I (xxx) UserProfile: 🧠 Learning: topic=chat, duration=5s
I (xxx) UserProfile:   📈 Total interactions: 0 → 1
I (xxx) UserProfile:   ⏱️  Avg session: 30s → 25s
I (xxx) UserProfile:   ⭐ Favorite topic: chat
I (xxx) UserProfile:   💾 Immediately saved to NVS  ✅ 关键！
```

✅ **检查点**：看到 `💾 Immediately saved to NVS` 说明立即保存成功。

#### Step 1.3：再对话 2 次
```
你："今天天气怎么样？"
你："今天天气怎么样？"
```

观察日志：
```
I (xxx) UserProfile:   📈 Total interactions: 1 → 2
I (xxx) UserProfile:   💾 Immediately saved to NVS

I (xxx) UserProfile:   📈 Total interactions: 2 → 3
I (xxx) UserProfile:   💾 Immediately saved to NVS
```

✅ **检查点**：互动次数从 0 → 1 → 2 → 3 递增。

#### Step 1.4：重启设备
在串口监视器中按：
- **Ctrl + T**，然后按 **Ctrl + R**（重启）
- 或者直接按设备上的 RESET 按钮

#### Step 1.5：观察启动日志（最关键）
```
I (xxx) UserProfile: 📥 Loaded from NVS: interactions_7d=3  ✅ 数据保留了！
```

✅ **成功标志**：`interactions_7d=3`，说明数据没有丢失！

#### Step 1.6：继续对话
```
你："今天天气怎么样？"
```

观察日志：
```
I (xxx) UserProfile:   📈 Total interactions: 3 → 4  ✅ 延续之前的数据！
```

✅ **成功标志**：从 3 → 4，而不是从 0 → 1。

---

## 🧪 测试 2：自适应学习体现（AI 行为）

### 目的
验证 AI 能够察觉并提及用户的行为模式。

### 步骤

#### Step 2.1：连续问同样的问题 5 次
```
你："今天天气怎么样？"
AI："今天成都..."

你："今天天气怎么样？"
AI："今天成都..."

你："今天天气怎么样？"
AI："今天成都..."

你："今天天气怎么样？"
AI："今天成都..."

你："今天天气怎么样？"
AI：[期待] "我发现你最近好像特别关心天气耶..."
```

#### Step 2.2：观察 AI 是否调用学习工具
日志中查找：
```
I (xxx) Application: << % self.learning.get_insights...
```

✅ **成功标志**：AI 调用了 `self.learning.get_insights` 工具。

#### Step 2.3：检查用户画像
```
你："你好小智"
你："宠物状态"
```

AI 应该说类似：
```
"你的犀牛心情 XX，饱腹 XX～
 
 诶等等，我发现这几天你找我聊天的次数变多了耶，
 已经 X 次啦！因为你最近常陪我，我帮你的宠物
 调整成更需要关注的模式了～"
```

✅ **成功标志**：AI 主动提及互动次数和宠物自适应。

---

## 🧪 测试 3：宠物系统基本功能

### 目的
验证宠物的状态管理和互动功能。

### 步骤

#### Step 3.1：查看宠物状态
```
你："宠物状态"
```

AI 回复：
```
"你的犀牛心情 70，饱腹 70，清洁 10"
```

#### Step 3.2：喂食
```
你："喂一下宠物"
```

观察日志：
```
I (xxx) Pet: 🍽️ Fed pet, Satiety: 70 → 75, Mood: 70 → 73
```

#### Step 3.3：清洁
```
你："给宠物洗澡"
```

观察日志：
```
I (xxx) Pet: 🛁 Cleaned pet, Cleanliness: 10 → 100, Mood: 73 → 76
```

#### Step 3.4：玩耍
```
你："陪宠物玩"
```

观察日志：
```
I (xxx) Pet: 🎮 Played with pet, Mood: 76 → 86
```

#### Step 3.5：换宠物
```
你："我要养熊猫"
```

观察日志：
```
I (xxx) Pet: 🐼 Selected pet type: panda
I (xxx) LcdDisplay: ✅ Set pet icon for emoji: 🐼
```

✅ **成功标志**：屏幕上的宠物图标变成熊猫 🐼。

---

## 🧪 测试 4：宠物自动播报（重要）

### 目的
验证宠物状态低时，会自动提醒用户。

### 步骤

#### Step 4.1：设置低清洁度
```
你："把清洁度设置为 5"
```

观察日志：
```
I (xxx) Pet: 🔧 Debug set: Mood=70, Satiety=70, Clean=5
```

#### Step 4.2：等待 3 分钟
在这期间**不要**和设备对话，让它保持 Idle 状态。

设置定时器 3 分钟，可以做其他事情。

#### Step 4.3：观察自动播报日志
3 分钟后，应该看到：
```
I (xxx) Pet: 🔔 Auto announcement triggered: 主人，🦏犀牛需要清洁一下了... (interval: 3 min)
I (xxx) Application: 🐾 Pet warning (device idle): 主人，🦏犀牛需要清洁一下了...
I (xxx) Application: 🔊 Sent TTS request to AI: 主人，🦏犀牛需要清洁一下了...
```

#### Step 4.4：听到小智说话
**期待效果**：
- 🔊 小智用声音说："主人，你的犀牛需要清洁一下了，不然会不舒服的。"
- 📺 屏幕上同时显示字幕

✅ **成功标志**：听到小智的声音，不只是叮叮叮。

#### Step 4.5：如果没有声音
如果只看到日志，没听到声音，可能是：

**情况 A：设备正在说话**
```
I (xxx) Application: 🔕 Pet warning suppressed (device busy, state=6)
```
→ 解决：等对话结束，应该会延迟播报

**情况 B：TTS 发送失败**
```
I (xxx) Application: ⚠️  Protocol not available, using fallback
```
→ 解决：检查网络连接

**情况 C：日志正常，但没声音**
→ 可能是 AI 服务器的问题，检查 xiaozhi.me 连接

---

## 🧪 测试 5：宠物自适应衰减

### 目的
验证宠物的衰减速度会根据用户互动频率调整。

### 步骤

#### Step 5.1：查看初始衰减速度
观察日志（每分钟会输出）：
```
I (xxx) Pet: 🔄 Decay: adaptive_rate=0.60x (7d互动=3次), mood=70→70, satiety=70→69, clean=5→4
```

- `adaptive_rate=0.60x` 表示衰减速度是正常的 60%（因为互动少）
- `7d互动=3次` 表示最近 7 天互动了 3 次

#### Step 5.2：增加互动次数
连续对话 10 次以上：
```
你："今天天气怎么样？"（重复 10 次）
```

#### Step 5.3：观察衰减速度变化
```
I (xxx) Pet: 🔄 Decay: adaptive_rate=1.20x (7d互动=13次), mood=70→69, satiety=69→68, clean=4→3
```

- `adaptive_rate=1.20x` 表示衰减速度变成了 120%（因为互动多了）
- `7d互动=13次` 表示互动次数增加了

✅ **成功标志**：互动越多，`adaptive_rate` 越大，宠物越需要照顾。

---

## 🧪 测试 6：完整场景测试

### 场景：新用户 → 活跃用户 → 长期用户

#### Day 1（新用户）
```
对话 2 次
观察：
- interactions_7d: 0 → 1 → 2
- adaptive_rate: 0.50x（低频用户）
- AI 语气：简洁友好
```

#### Day 2（变活跃）
```
对话 10 次
观察：
- interactions_7d: 2 → 12
- adaptive_rate: 1.0x → 1.2x（中频→高频）
- AI 语气：开始提及"你最近常找我聊天～"
```

#### Day 3（重启测试）
```
重启设备
观察：
- 启动日志：interactions_7d=12（数据保留）
- 继续对话：12 → 13（延续）
```

✅ **成功标志**：整个过程数据一致，AI 行为有变化。

---

## 🎯 快速测试清单

如果时间有限，按这个顺序测试最核心的功能：

### ✅ 必测（5 分钟）
1. **学习数据保存**：对话 3 次 → 重启 → 观察数据是否保留
2. **宠物基本功能**：查看状态、喂食、清洁
3. **自适应衰减**：观察日志中的 `adaptive_rate`

### ⏳ 推荐测试（10 分钟）
4. **自动播报**：设置低清洁度 → 等待 3 分钟 → 听到播报
5. **AI 学习体现**：连续问同样问题 5 次 → AI 提及

### 🌟 完整测试（20 分钟）
6. **换宠物类型**：测试不同宠物的衰减速度
7. **长期场景**：模拟多天使用

---

## 📊 测试结果记录表

| 测试项 | 预期结果 | 实际结果 | 状态 |
|--------|---------|---------|------|
| 1. 学习数据保存 | 重启后 interactions 延续 | ___/3 → ___/4 | ⬜ |
| 2. 立即保存日志 | 每次看到 `💾 Immediately saved` | YES / NO | ⬜ |
| 3. AI 调用 get_insights | 看到 `% self.learning.get_insights` | YES / NO | ⬜ |
| 4. AI 提及互动次数 | 说"你最近..." | YES / NO | ⬜ |
| 5. 宠物基本功能 | 喂食、清洁、玩耍正常 | YES / NO | ⬜ |
| 6. 自动播报触发 | 3 分钟后看到日志 | YES / NO | ⬜ |
| 7. 自动播报声音 | 听到小智说话 | YES / NO | ⬜ |
| 8. 自适应衰减 | `adaptive_rate` 随互动变化 | 0.6x → __x | ⬜ |

---

## 🔍 常见问题排查

### Q1：重启后 interactions 还是 0 → 1
**检查**：
```bash
grep "💾 Immediately saved" 日志
```
如果没有这行，说明代码没编译进去，需要重新 `idf.py build flash`。

### Q2：AI 不调用 get_insights
**原因**：可能需要更多对话次数，或者 AI 判断不需要调用。
**解决**：继续对话，或者直接问"你觉得我最近怎么样？"触发。

### Q3：宠物播报只有日志，没声音
**检查日志**：
```
🔕 Pet warning suppressed (device busy)
```
→ 设备在说话，等它空闲

```
🔊 Sent TTS request to AI
```
但没声音 → 检查网络连接或 AI 服务器

### Q4：adaptive_rate 不变化
**原因**：互动次数还不够多（需要 >5 次才明显）。
**解决**：多对话几次，观察 `7d互动=N次` 的变化。

---

## 🎉 成功标志汇总

所有这些都应该能看到/听到：

✅ **日志**：
- `💾 Immediately saved to NVS`
- `📥 Loaded from NVS: interactions_7d=X`
- `🔔 Auto announcement triggered`
- `🔊 Sent TTS request to AI`
- `🔄 Decay: adaptive_rate=X.XXx`

✅ **屏幕**：
- 宠物图标（🦏 → 🐼）
- 警告字幕

✅ **声音**：
- 小智说："主人，你的犀牛需要清洁..."

✅ **AI 对话**：
- "我发现你最近好像特别..."
- "这几天你找我聊天的次数变多了..."

---

**按这个指南测试，有任何问题随时告诉我！** 🚀

Good luck! 🎉


