# ğŸ¤ è¯­éŸ³è¾“å…¥ä¸ AFE é¢„å¤„ç†è¯¦è§£

> æœ¬æ–‡æ¡£åŸºäº Otto æœºå™¨äººé¡¹ç›®çš„å®é™…ä»£ç ï¼Œè¯¦ç»†è®²è§£è¯­éŸ³è¾“å…¥å’ŒéŸ³é¢‘å‰ç«¯å¤„ç†ï¼ˆAFEï¼‰çš„åŸç†ä¸å®ç°ã€‚

---

## ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [å£°éŸ³çš„æ•°å­—åŒ–](#2-å£°éŸ³çš„æ•°å­—åŒ–)
3. [I2S éŸ³é¢‘æ¥å£](#3-i2s-éŸ³é¢‘æ¥å£)
4. [éŸ³é¢‘ç¼–è§£ç å™¨ (Audio Codec)](#4-éŸ³é¢‘ç¼–è§£ç å™¨-audio-codec)
5. [éŸ³é¢‘å‰ç«¯å¤„ç† (AFE)](#5-éŸ³é¢‘å‰ç«¯å¤„ç†-afe)
6. [å®Œæ•´æ•°æ®æµ](#6-å®Œæ•´æ•°æ®æµ)
7. [ä»£ç è¯¦è§£](#7-ä»£ç è¯¦è§£)

---

## 1. æ¦‚è¿°

è¯­éŸ³äº¤äº’ç³»ç»Ÿçš„ç¬¬ä¸€æ­¥æ˜¯**é‡‡é›†å’Œå¤„ç†å£°éŸ³**ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è¯­éŸ³è¾“å…¥å¤„ç†æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ¤ éº¦å…‹é£ â†’ ğŸ“¡ I2Sä¼ è¾“ â†’ ğŸ”§ AFEå¤„ç† â†’ ğŸ“¤ è¾“å‡ºå¹²å‡€éŸ³é¢‘           â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â”œâ”€â”€ AEC (å›å£°æ¶ˆé™¤)                  â”‚
â”‚                              â”œâ”€â”€ NS  (é™å™ª)                      â”‚
â”‚                              â”œâ”€â”€ VAD (è¯­éŸ³æ£€æµ‹)                  â”‚
â”‚                              â””â”€â”€ AGC (è‡ªåŠ¨å¢ç›Š)                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. å£°éŸ³çš„æ•°å­—åŒ–

### 2.1 ä»€ä¹ˆæ˜¯é‡‡æ ·ï¼Ÿ

å£°éŸ³æ˜¯ç©ºæ°”çš„æŒ¯åŠ¨ï¼ˆæ¨¡æ‹Ÿä¿¡å·ï¼‰ï¼Œè®¡ç®—æœºåªèƒ½å¤„ç†æ•°å­—ä¿¡å·ã€‚
**é‡‡æ ·**å°±æ˜¯æŠŠè¿ç»­çš„å£°æ³¢è½¬æ¢æˆç¦»æ•£çš„æ•°å­—ç‚¹ã€‚

```
æ¨¡æ‹Ÿå£°æ³¢ï¼ˆè¿ç»­ï¼‰                    æ•°å­—ä¿¡å·ï¼ˆç¦»æ•£ï¼‰
                                   
    âˆ¿                              [120]
   âˆ¿ âˆ¿                                   [85]
  âˆ¿   âˆ¿                                        [-30]
 âˆ¿     âˆ¿                                              [45]
âˆ¿       âˆ¿                                                   [100]
         âˆ¿                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
          âˆ¿âˆ¿                       æ—¶é—´è½´ä¸Šçš„é‡‡æ ·ç‚¹
```

### 2.2 å…³é”®å‚æ•°

| å‚æ•° | å«ä¹‰ | Otto æœºå™¨äººé…ç½® | è¯´æ˜ |
|------|------|----------------|------|
| **é‡‡æ ·ç‡** | æ¯ç§’é‡‡é›†å¤šå°‘ä¸ªç‚¹ | 16000 Hz | è¯­éŸ³è¯†åˆ«æ ‡å‡†é‡‡æ ·ç‡ |
| **ä½æ·±** | æ¯ä¸ªç‚¹ç”¨å¤šå°‘ä½è¡¨ç¤º | 16 bit | èŒƒå›´ -32768 ~ 32767 |
| **é€šé“æ•°** | å‡ ä¸ªéº¦å…‹é£ | 1~2 | å•å£°é“æˆ–å¸¦å‚è€ƒé€šé“ |


### 2.3 æ•°æ®é‡è®¡ç®—

```
é‡‡æ ·ç‡ 16000 Hz Ã— ä½æ·± 16 bit = æ¯ç§’ 256,000 bit = 32 KB/ç§’

1åˆ†é’ŸéŸ³é¢‘ = 32 KB Ã— 60 = 1.92 MB
```

### 2.4 Otto æœºå™¨äººçš„é…ç½®

```cpp
// main/boards/otto-robot/config.h

#define AUDIO_INPUT_SAMPLE_RATE 16000   // éº¦å…‹é£è¾“å…¥é‡‡æ ·ç‡ï¼š16kHz
#define AUDIO_OUTPUT_SAMPLE_RATE 16000  // æ‰¬å£°å™¨è¾“å‡ºé‡‡æ ·ç‡ï¼š16kHz
```

**ä¸ºä»€ä¹ˆé€‰æ‹© 16kHzï¼Ÿ**
- äººå£°é¢‘ç‡èŒƒå›´ï¼š300Hz ~ 3400Hz
- æ ¹æ®å¥ˆå¥æ–¯ç‰¹å®šç†ï¼Œé‡‡æ ·ç‡éœ€è¦ â‰¥ 2 Ã— æœ€é«˜é¢‘ç‡
- 16kHz è¶³å¤Ÿè¦†ç›–äººå£°ï¼Œä¸”æ•°æ®é‡é€‚ä¸­

---

## 3. I2S éŸ³é¢‘æ¥å£

### 3.1 ä»€ä¹ˆæ˜¯ I2Sï¼Ÿ

**I2S (Inter-IC Sound)** æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºä¼ è¾“æ•°å­—éŸ³é¢‘çš„åè®®ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   INMP441   â”‚                    â”‚   ESP32-S3  â”‚
â”‚   æ•°å­—éº¦å…‹é£  â”‚                    â”‚             â”‚
â”‚             â”‚                    â”‚             â”‚
â”‚   WS  â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ GPIO 4    â”‚  å·¦å³å£°é“æ—¶é’Ÿ
â”‚   SCK â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ GPIO 5    â”‚  ä½æ—¶é’Ÿ
â”‚   SD  â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ GPIO 6    â”‚  æ•°æ®çº¿
â”‚             â”‚                    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 I2S çš„ä¸‰æ ¹ä¿¡å·çº¿

| ä¿¡å· | å…¨ç§° | ä½œç”¨ |
|------|------|------|
| **SCK/BCLK** | Bit Clock | ä½æ—¶é’Ÿï¼Œæ¯ä¸ªé‡‡æ ·ç‚¹çš„èŠ‚æ‹ |
| **WS/LRCLK** | Word Select | å­—é€‰æ‹©ï¼ŒåŒºåˆ†å·¦å³å£°é“ |
| **SD/DATA** | Serial Data | ä¸²è¡Œæ•°æ®ï¼Œå®é™…çš„éŸ³é¢‘æ•°æ® |

### 3.3 Otto æœºå™¨äººçš„ I2S å¼•è„šé…ç½®

```cpp
// main/boards/otto-robot/config.h

// éº¦å…‹é£ I2S å¼•è„š
#define AUDIO_I2S_MIC_GPIO_WS   GPIO_NUM_4   // å·¦å³å£°é“æ—¶é’Ÿ
#define AUDIO_I2S_MIC_GPIO_SCK  GPIO_NUM_5   // ä½æ—¶é’Ÿ
#define AUDIO_I2S_MIC_GPIO_DIN  GPIO_NUM_6   // æ•°æ®è¾“å…¥

// æ‰¬å£°å™¨ I2S å¼•è„š
#define AUDIO_I2S_SPK_GPIO_DOUT GPIO_NUM_7   // æ•°æ®è¾“å‡º
#define AUDIO_I2S_SPK_GPIO_BCLK GPIO_NUM_15  // ä½æ—¶é’Ÿ
#define AUDIO_I2S_SPK_GPIO_LRCK GPIO_NUM_16  // å·¦å³å£°é“æ—¶é’Ÿ
```

### 3.4 ç¡¬ä»¶è¿æ¥å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Otto æœºå™¨äººéŸ³é¢‘ç¡¬ä»¶                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  INMP441    â”‚         â”‚   ESP32-S3  â”‚         â”‚  MAX98357  â”‚ â”‚
â”‚  â”‚  æ•°å­—éº¦å…‹é£  â”‚         â”‚             â”‚         â”‚  åŠŸæ”¾èŠ¯ç‰‡   â”‚ â”‚
â”‚  â”‚             â”‚         â”‚             â”‚         â”‚            â”‚ â”‚
â”‚  â”‚  WS â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ GPIO 4     â”‚         â”‚            â”‚ â”‚
â”‚  â”‚  SCK â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ GPIO 5     â”‚         â”‚            â”‚ â”‚
â”‚  â”‚  SD â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ GPIO 6     â”‚         â”‚            â”‚ â”‚
â”‚  â”‚             â”‚         â”‚             â”‚         â”‚            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   GPIO 7  â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ DIN       â”‚ â”‚
â”‚                          â”‚   GPIO 15 â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ BCLK      â”‚ â”‚
â”‚                          â”‚   GPIO 16 â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ LRC       â”‚ â”‚
â”‚                          â”‚             â”‚         â”‚            â”‚ â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                        â”‚        â”‚
â”‚                                                   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”‚
â”‚                                                   â”‚  æ‰¬å£°å™¨  â”‚   â”‚
â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. éŸ³é¢‘ç¼–è§£ç å™¨ (Audio Codec)

### 4.1 AudioCodec åŸºç±»

AudioCodec æ˜¯éŸ³é¢‘è¾“å…¥è¾“å‡ºçš„æŠ½è±¡å±‚ï¼Œå®šä¹‰äº†ç»Ÿä¸€çš„æ¥å£ï¼š

```cpp
// main/audio/audio_codec.h

class AudioCodec {
public:
    // è¾“å‡ºéŸ³é¢‘åˆ°æ‰¬å£°å™¨
    virtual void OutputData(std::vector<int16_t>& data);
    
    // ä»éº¦å…‹é£è¯»å–éŸ³é¢‘
    virtual bool InputData(std::vector<int16_t>& data);
    
    // è®¾ç½®éŸ³é‡ (0-100)
    virtual void SetOutputVolume(int volume);
    
    // å¯ç”¨/ç¦ç”¨è¾“å…¥è¾“å‡º
    virtual void EnableInput(bool enable);
    virtual void EnableOutput(bool enable);

protected:
    i2s_chan_handle_t tx_handle_;  // I2S å‘é€é€šé“ï¼ˆæ‰¬å£°å™¨ï¼‰
    i2s_chan_handle_t rx_handle_;  // I2S æ¥æ”¶é€šé“ï¼ˆéº¦å…‹é£ï¼‰
    
    int input_sample_rate_ = 16000;
    int output_sample_rate_ = 16000;
    int input_channels_ = 1;
    bool input_reference_ = false;  // æ˜¯å¦æœ‰ AEC å‚è€ƒé€šé“
};
```


### 4.2 Otto ä½¿ç”¨çš„ç¼–è§£ç å™¨ï¼šNoAudioCodecSimplexAec

Otto æœºå™¨äººä½¿ç”¨ `NoAudioCodecSimplexAec`ï¼Œæ”¯æŒè½¯ä»¶ AECï¼ˆå›å£°æ¶ˆé™¤ï¼‰ï¼š

```cpp
// main/boards/otto-robot/otto_robot.cc

virtual AudioCodec* GetAudioCodec() override {
    // ä½¿ç”¨æ”¯æŒè½¯ä»¶ AEC å‚è€ƒä¿¡å·çš„ç¼–è§£ç å™¨
    static NoAudioCodecSimplexAec audio_codec(
        AUDIO_INPUT_SAMPLE_RATE,      // 16000 Hz
        AUDIO_OUTPUT_SAMPLE_RATE,     // 16000 Hz
        AUDIO_I2S_SPK_GPIO_BCLK,      // GPIO 15
        AUDIO_I2S_SPK_GPIO_LRCK,      // GPIO 16
        AUDIO_I2S_SPK_GPIO_DOUT,      // GPIO 7
        AUDIO_I2S_MIC_GPIO_SCK,       // GPIO 5
        AUDIO_I2S_MIC_GPIO_WS,        // GPIO 4
        AUDIO_I2S_MIC_GPIO_DIN        // GPIO 6
    );
    return &audio_codec;
}
```

### 4.3 I2S é€šé“åˆå§‹åŒ–ä»£ç è¯¦è§£

```cpp
// main/audio/codecs/no_audio_codec.cc

NoAudioCodecSimplexAec::NoAudioCodecSimplexAec(...) {
    duplex_ = false;
    input_reference_ = true;   // â­ å¯ç”¨ AEC å‚è€ƒä¿¡å·
    input_channels_ = 2;       // â­ 2 é€šé“ï¼šéº¦å…‹é£ + å‚è€ƒ
    
    // 1. åˆ›å»ºæ‰¬å£°å™¨ I2S é€šé“
    i2s_chan_config_t chan_cfg = {
        .id = (i2s_port_t)0,           // ä½¿ç”¨ I2S ç«¯å£ 0
        .role = I2S_ROLE_MASTER,       // ESP32 ä½œä¸ºä¸»è®¾å¤‡
        .dma_desc_num = 6,             // DMA æè¿°ç¬¦æ•°é‡
        .dma_frame_num = 240,          // æ¯ä¸ª DMA å¸§çš„é‡‡æ ·æ•°
        .auto_clear_after_cb = true,   // å›è°ƒåè‡ªåŠ¨æ¸…é™¤
    };
    i2s_new_channel(&chan_cfg, &tx_handle_, nullptr);
    
    // 2. é…ç½® I2S æ ‡å‡†æ¨¡å¼
    i2s_std_config_t std_cfg = {
        .clk_cfg = {
            .sample_rate_hz = 16000,           // é‡‡æ ·ç‡
            .clk_src = I2S_CLK_SRC_DEFAULT,    // é»˜è®¤æ—¶é’Ÿæº
            .mclk_multiple = I2S_MCLK_MULTIPLE_256,  // MCLK å€é¢‘
        },
        .slot_cfg = {
            .data_bit_width = I2S_DATA_BIT_WIDTH_32BIT,  // 32ä½æ•°æ®
            .slot_mode = I2S_SLOT_MODE_MONO,             // å•å£°é“
            .slot_mask = I2S_STD_SLOT_LEFT,              // å·¦å£°é“
        },
        .gpio_cfg = {
            .bclk = spk_bclk,   // ä½æ—¶é’Ÿå¼•è„š
            .ws = spk_ws,       // å­—é€‰æ‹©å¼•è„š
            .dout = spk_dout,   // æ•°æ®è¾“å‡ºå¼•è„š
        }
    };
    i2s_channel_init_std_mode(tx_handle_, &std_cfg);
    
    // 3. åˆ›å»ºéº¦å…‹é£ I2S é€šé“ï¼ˆä½¿ç”¨ I2S ç«¯å£ 1ï¼‰
    chan_cfg.id = (i2s_port_t)1;
    i2s_new_channel(&chan_cfg, nullptr, &rx_handle_);
    // ... é…ç½®éº¦å…‹é£å‚æ•°
}
```

### 4.4 éŸ³é¢‘è¯»å–ä¸ AEC å‚è€ƒä¿¡å·

```cpp
// main/audio/codecs/no_audio_codec.cc

int NoAudioCodecSimplexAec::Read(int16_t* dest, int samples) {
    int mic_samples = samples / 2;  // å®é™…éº¦å…‹é£æ ·æœ¬æ•°
    
    // 1. ä» I2S è¯»å–éº¦å…‹é£æ•°æ®ï¼ˆ32ä½æ ¼å¼ï¼‰
    std::vector<int32_t> bit32_buffer(mic_samples);
    i2s_channel_read(rx_handle_, bit32_buffer.data(), 
                     mic_samples * sizeof(int32_t), &bytes_read, portMAX_DELAY);
    
    // 2. äº¤ç»‡éº¦å…‹é£æ•°æ®å’Œå‚è€ƒæ•°æ®
    // è¾“å‡ºæ ¼å¼ï¼š[mic0, ref0, mic1, ref1, mic2, ref2, ...]
    for (int i = 0; i < actual_mic_samples; i++) {
        // éº¦å…‹é£æ•°æ®ï¼š32ä½è½¬16ä½
        int32_t value = bit32_buffer[i] >> 12;
        dest[i * 2] = (int16_t)value;
        
        // å‚è€ƒæ•°æ®ï¼šä»æ’­æ”¾ç¼“å†²åŒºè·å–ï¼ˆç”¨äº AECï¼‰
        // â­ å…³é”®ï¼šå‚è€ƒä¿¡å·éœ€è¦å»¶è¿Ÿå¯¹é½
        size_t ref_pos = (ref_write_pos_ + kRefBufferSize 
                         - kAecDelaySamples - actual_mic_samples + i) 
                         % kRefBufferSize;
        dest[i * 2 + 1] = ref_buffer_[ref_pos];
    }
    
    return actual_mic_samples * 2;
}
```

**ä¸ºä»€ä¹ˆéœ€è¦å‚è€ƒä¿¡å·ï¼Ÿ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AEC å‚è€ƒä¿¡å·åŸç†                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  æ‰¬å£°å™¨æ’­æ”¾: "ä»Šå¤©å¤©æ°”å¾ˆå¥½"                                       â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â†’ ç›´æ¥è¾“å‡ºåˆ°æ‰¬å£°å™¨                                      â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€â†’ ä¿å­˜åˆ°å‚è€ƒç¼“å†²åŒº â”€â”€â†’ æä¾›ç»™ AEC ç®—æ³•                   â”‚
â”‚                                                                 â”‚
â”‚  éº¦å…‹é£é‡‡é›†: ä½ çš„å£°éŸ³ + æ‰¬å£°å™¨çš„å›å£°                               â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€â†’ AEC ç®—æ³•ç”¨å‚è€ƒä¿¡å·æ¶ˆé™¤å›å£° â”€â”€â†’ åªå‰©ä½ çš„å£°éŸ³            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. éŸ³é¢‘å‰ç«¯å¤„ç† (AFE)

### 5.1 ä»€ä¹ˆæ˜¯ AFEï¼Ÿ

**AFE (Audio Front-End)** æ˜¯éŸ³é¢‘å‰ç«¯å¤„ç†æ¨¡å—ï¼Œè´Ÿè´£å¯¹åŸå§‹éŸ³é¢‘è¿›è¡Œé¢„å¤„ç†ï¼Œ
è®©åç»­çš„è¯­éŸ³è¯†åˆ«æ›´å‡†ç¡®ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AFE å¤„ç†æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  åŸå§‹éŸ³é¢‘ â”€â”€â†’ AEC â”€â”€â†’ NS â”€â”€â†’ VAD â”€â”€â†’ AGC â”€â”€â†’ å¹²å‡€éŸ³é¢‘           â”‚
â”‚              â”‚       â”‚       â”‚       â”‚                          â”‚
â”‚              â”‚       â”‚       â”‚       â””â”€â”€ è‡ªåŠ¨å¢ç›Šæ§åˆ¶            â”‚
â”‚              â”‚       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¯­éŸ³æ´»åŠ¨æ£€æµ‹            â”‚
â”‚              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é™å™ª                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å›å£°æ¶ˆé™¤               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 5.2 AFE å„æ¨¡å—è¯¦è§£

#### 5.2.1 AEC - å›å£°æ¶ˆé™¤ (Acoustic Echo Cancellation)

**é—®é¢˜åœºæ™¯ï¼š**
```
æœºå™¨äººè¯´è¯æ—¶ï¼Œæ‰¬å£°å™¨çš„å£°éŸ³ä¼šè¢«éº¦å…‹é£é‡‡é›†åˆ°ï¼ˆå›å£°ï¼‰
å¦‚æœä¸å¤„ç†ï¼Œæœºå™¨äººä¼š"å¬åˆ°è‡ªå·±è¯´è¯"ï¼Œå¯¼è‡´ï¼š
- è¯¯è§¦å‘å”¤é†’è¯
- è¯­éŸ³è¯†åˆ«é”™è¯¯
- æ— æ³•å®ç°æ‰“æ–­åŠŸèƒ½
```

**AEC åŸç†ï¼š**
```
éº¦å…‹é£ä¿¡å· = ç”¨æˆ·å£°éŸ³ + å›å£°
å‚è€ƒä¿¡å·   = æ‰¬å£°å™¨æ’­æ”¾çš„å†…å®¹ï¼ˆå›å£°çš„æ¥æºï¼‰

AEC ç®—æ³•ï¼šéº¦å…‹é£ä¿¡å· - ä¼°è®¡çš„å›å£° â‰ˆ ç”¨æˆ·å£°éŸ³
```

**Otto çš„ AEC é…ç½®ï¼š**
```cpp
// main/audio/processors/afe_audio_processor.cc

afe_config->aec_init = codec_->input_reference();  // æœ‰å‚è€ƒé€šé“æ‰å¯ç”¨
afe_config->aec_mode = AEC_MODE_SR_LOW_COST;       // ä½åŠŸè€—æ¨¡å¼

// ğŸ›¡ï¸ ä½¿ç”¨ SR_LOW_COST æ¨¡å¼ï¼ŒVOIP æ¨¡å¼å¤ªè€— CPU ä¼šè§¦å‘çœ‹é—¨ç‹—
```

#### 5.2.2 NS - é™å™ª (Noise Suppression)

**ä½œç”¨ï¼š** å»é™¤ç¯å¢ƒå™ªéŸ³ï¼ˆé£æ‰‡å£°ã€ç©ºè°ƒå£°ã€èƒŒæ™¯æ‚éŸ³ç­‰ï¼‰

**ä¸¤ç§é™å™ªæ¨¡å¼ï¼š**

| æ¨¡å¼ | è¯´æ˜ | æ•ˆæœ | CPU å ç”¨ |
|------|------|------|----------|
| WebRTC NS | ä¼ ç»Ÿç®—æ³• | ä¸€èˆ¬ | ä½ |
| NSNet (ç¥ç»ç½‘ç»œ) | æ·±åº¦å­¦ä¹ æ¨¡å‹ | ä¼˜ç§€ | é«˜ |

**Otto çš„ NS é…ç½®ï¼š**
```cpp
// main/audio/processors/afe_audio_processor.cc

// æŸ¥æ‰¾ç¥ç»ç½‘ç»œé™å™ªæ¨¡å‹
char* ns_model_name = esp_srmodel_filter(models, ESP_NSNET_PREFIX, "nsnet2");

if (ns_model_name != nullptr) {
    afe_config->ns_init = true;
    afe_config->ns_model_name = ns_model_name;
    afe_config->afe_ns_mode = AFE_NS_MODE_NET;  // ä½¿ç”¨ç¥ç»ç½‘ç»œé™å™ª
    ESP_LOGI(TAG, "âœ… ä½¿ç”¨ ESP-SR ç¥ç»ç½‘ç»œé™å™ª: %s", ns_model_name);
} else {
    afe_config->ns_init = false;
    ESP_LOGW(TAG, "âš ï¸ æœªæ‰¾åˆ° NS é™å™ªæ¨¡å‹ï¼Œé™å™ªå·²ç¦ç”¨");
}
```

#### 5.2.3 VAD - è¯­éŸ³æ´»åŠ¨æ£€æµ‹ (Voice Activity Detection)

**ä½œç”¨ï¼š** æ£€æµ‹éŸ³é¢‘ä¸­æ˜¯å¦æœ‰äººåœ¨è¯´è¯

**åº”ç”¨åœºæ™¯ï¼š**
- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¼€å§‹/ç»“æŸè¯´è¯
- èŠ‚çœå¸¦å®½ï¼ˆåªä¼ è¾“æœ‰è¯­éŸ³çš„éƒ¨åˆ†ï¼‰
- è§¦å‘åç»­å¤„ç†æµç¨‹

**VAD çŠ¶æ€ï¼š**
```cpp
typedef enum {
    VAD_SILENCE = 0,  // é™éŸ³çŠ¶æ€
    VAD_SPEECH  = 1,  // è¯´è¯çŠ¶æ€
} vad_state_t;
```

**Otto çš„ VAD é…ç½®ï¼š**
```cpp
// main/audio/processors/afe_audio_processor.cc

// ä½¿ç”¨ç¥ç»ç½‘ç»œ VAD æ¨¡å‹
char* vad_model_name = esp_srmodel_filter(models, ESP_VADN_PREFIX, "vadnet1_medium");

afe_config->vad_init = true;
afe_config->vad_mode = VAD_MODE_3;        // æœ€çµæ•æ¨¡å¼ (0-3)
afe_config->vad_min_noise_ms = 50;        // å™ªå£°åˆ¤æ–­æ—¶é—´
afe_config->vad_model_name = vad_model_name;

ESP_LOGI(TAG, "âœ… VAD äººå£°æ£€æµ‹: ç¥ç»ç½‘ç»œæ¨¡å¼ (Level 3 é«˜çµæ•)");
```

#### 5.2.4 AGC - è‡ªåŠ¨å¢ç›Šæ§åˆ¶ (Automatic Gain Control)

**ä½œç”¨ï¼š** è‡ªåŠ¨è°ƒæ•´éŸ³é‡ï¼Œè®©å£°éŸ³å¤§å°ä¸€è‡´

**åœºæ™¯ï¼š**
- ç”¨æˆ·ç¦»éº¦å…‹é£è¿œ â†’ å£°éŸ³å° â†’ AGC æ”¾å¤§
- ç”¨æˆ·ç¦»éº¦å…‹é£è¿‘ â†’ å£°éŸ³å¤§ â†’ AGC å‹ç¼©

**Otto çš„ AGC é…ç½®ï¼š**
```cpp
// main/audio/processors/afe_audio_processor.cc

afe_config->agc_init = true;
afe_config->agc_mode = AFE_AGC_MODE_WEBRTC;
afe_config->agc_compression_gain_db = 15;   // å‹ç¼©å¢ç›Š 15dB
afe_config->agc_target_level_dbfs = 3;      // ç›®æ ‡ç”µå¹³ -3dBFS

ESP_LOGI(TAG, "âœ… AGC è‡ªåŠ¨å¢ç›Šæ§åˆ¶: WEBRTC æ¨¡å¼ (å¢ç›Š=15dB)");
```

#### 5.2.5 SE - è¯­éŸ³å¢å¼º (Speech Enhancement)

**ä½œç”¨ï¼š** çªå‡ºäººå£°é¢‘æ®µï¼ŒæŠ‘åˆ¶éäººå£°ï¼ˆå¦‚éŸ³ä¹ï¼‰

```cpp
afe_config->se_init = true;
ESP_LOGI(TAG, "âœ… SE è¯­éŸ³å¢å¼º: å·²å¯ç”¨ï¼ˆçªå‡ºäººå£°é¢‘æ®µï¼ŒæŠ‘åˆ¶éŸ³ä¹ï¼‰");
```

### 5.3 AFE å®Œæ•´é…ç½®ä»£ç 

```cpp
// main/audio/processors/afe_audio_processor.cc

void AfeAudioProcessor::Initialize(AudioCodec* codec, int frame_duration_ms, 
                                   srmodel_list_t* models_list) {
    // 1. ç¡®å®šè¾“å…¥æ ¼å¼
    // M = éº¦å…‹é£é€šé“, R = å‚è€ƒé€šé“ï¼ˆç”¨äº AECï¼‰
    std::string input_format;
    for (int i = 0; i < codec_->input_channels() - ref_num; i++) {
        input_format.push_back('M');  // éº¦å…‹é£
    }
    for (int i = 0; i < ref_num; i++) {
        input_format.push_back('R');  // å‚è€ƒï¼ˆAECï¼‰
    }
    // Otto: input_format = "MR" (1ä¸ªéº¦å…‹é£ + 1ä¸ªå‚è€ƒ)
    
    // 2. åˆ›å»º AFE é…ç½®
    afe_config_t* afe_config = afe_config_init(
        input_format.c_str(),    // "MR"
        models,                  // æ¨¡å‹åˆ—è¡¨
        AFE_TYPE_VC,            // è¯­éŸ³é€šä¿¡ç±»å‹
        AFE_MODE_LOW_COST       // ä½åŠŸè€—æ¨¡å¼
    );
    
    // 3. é…ç½®å„ä¸ªæ¨¡å—
    afe_config->aec_init = true;                    // å›å£°æ¶ˆé™¤
    afe_config->aec_mode = AEC_MODE_SR_LOW_COST;
    
    afe_config->ns_init = true;                     // é™å™ª
    afe_config->afe_ns_mode = AFE_NS_MODE_NET;
    
    afe_config->vad_init = true;                    // è¯­éŸ³æ£€æµ‹
    afe_config->vad_mode = VAD_MODE_3;
    
    afe_config->agc_init = true;                    // è‡ªåŠ¨å¢ç›Š
    afe_config->agc_mode = AFE_AGC_MODE_WEBRTC;
    
    afe_config->se_init = true;                     // è¯­éŸ³å¢å¼º
    
    // 4. æ€§èƒ½ä¼˜åŒ–é…ç½®
    afe_config->memory_alloc_mode = AFE_MEMORY_ALLOC_MORE_PSRAM;  // ä½¿ç”¨ PSRAM
    afe_config->afe_ringbuf_size = 1000;            // ç¯å½¢ç¼“å†²åŒºå¤§å°
    afe_config->afe_perferred_core = 1;             // å›ºå®šåˆ° CPU1
    afe_config->afe_perferred_priority = 4;         // ä»»åŠ¡ä¼˜å…ˆçº§
    
    // 5. åˆ›å»º AFE å®ä¾‹
    afe_iface_ = esp_afe_handle_from_config(afe_config);
    afe_data_ = afe_iface_->create_from_config(afe_config);
}
```


---

## 6. å®Œæ•´æ•°æ®æµ

### 6.1 éŸ³é¢‘è¾“å…¥æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         éŸ³é¢‘è¾“å…¥å®Œæ•´æ•°æ®æµ                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  éº¦å…‹é£  â”‚ â†’  â”‚  I2S    â”‚ â†’  â”‚ Codec   â”‚ â†’  â”‚  AFE    â”‚              â”‚
â”‚  â”‚ INMP441 â”‚    â”‚ æ¥æ”¶    â”‚    â”‚  Read   â”‚    â”‚ å¤„ç†    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚       â”‚              â”‚              â”‚              â”‚                    â”‚
â”‚       â”‚              â”‚              â”‚              â†“                    â”‚
â”‚   æ¨¡æ‹Ÿâ†’æ•°å­—      32bitæ•°æ®      16bit PCM     å¹²å‡€éŸ³é¢‘                  â”‚
â”‚                                                    â”‚                    â”‚
â”‚                                                    â†“                    â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                                    â”‚      åç»­å¤„ç†             â”‚        â”‚
â”‚                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚                                    â”‚ â€¢ å”¤é†’è¯æ£€æµ‹ (WakeNet)    â”‚        â”‚
â”‚                                    â”‚ â€¢ è¯­éŸ³è¯†åˆ« (ASR)          â”‚        â”‚
â”‚                                    â”‚ â€¢ Opus ç¼–ç å‘é€åˆ°æœåŠ¡å™¨   â”‚        â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æ•°æ®æ ¼å¼è½¬æ¢

```
I2S åŸå§‹æ•°æ® (32-bit)          è½¬æ¢å (16-bit)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0x12345678         â”‚   â†’     â”‚ 0x1234       â”‚
â”‚ (32ä½æœ‰ç¬¦å·æ•´æ•°)    â”‚  >>12   â”‚ (16ä½æœ‰ç¬¦å·)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä»£ç å®ç°ï¼š
int32_t value = bit32_buffer[i] >> 12;
dest[i] = (int16_t)value;
```

### 6.3 åŒé€šé“æ•°æ®æ ¼å¼ï¼ˆå¸¦ AEC å‚è€ƒï¼‰

```
è¾“å‡ºæ•°æ®æ ¼å¼ï¼š[mic0, ref0, mic1, ref1, mic2, ref2, ...]

ç´¢å¼•:    0      1      2      3      4      5
æ•°æ®: [mic0] [ref0] [mic1] [ref1] [mic2] [ref2] ...
        â”‚      â”‚      â”‚      â”‚      â”‚      â”‚
        â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€ äº¤ç»‡æ’åˆ—

AFE å¤„ç†æ—¶ï¼š
- å¶æ•°ç´¢å¼• (0,2,4...) = éº¦å…‹é£æ•°æ® â†’ éœ€è¦å¤„ç†
- å¥‡æ•°ç´¢å¼• (1,3,5...) = å‚è€ƒæ•°æ® â†’ ç”¨äº AEC æ¶ˆé™¤å›å£°
```

---

## 7. ä»£ç è¯¦è§£

### 7.1 AudioService - éŸ³é¢‘æœåŠ¡ä¸»ç±»

AudioService æ˜¯éŸ³é¢‘ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œç®¡ç†æ‰€æœ‰éŸ³é¢‘ç›¸å…³çš„ä»»åŠ¡ï¼š

```cpp
// main/audio/audio_service.cc

class AudioService {
    // æ ¸å¿ƒç»„ä»¶
    AudioCodec* codec_;                              // éŸ³é¢‘ç¼–è§£ç å™¨
    std::unique_ptr<AudioProcessor> audio_processor_; // AFE å¤„ç†å™¨
    std::unique_ptr<WakeWord> wake_word_;            // å”¤é†’è¯æ£€æµ‹
    
    // ç¼–è§£ç å™¨
    std::unique_ptr<OpusEncoderWrapper> opus_encoder_;  // Opus ç¼–ç 
    std::unique_ptr<OpusDecoderWrapper> opus_decoder_;  // Opus è§£ç 
    
    // ä»»åŠ¡é˜Ÿåˆ—
    std::deque<AudioTask> audio_encode_queue_;   // å¾…ç¼–ç é˜Ÿåˆ—
    std::deque<AudioTask> audio_decode_queue_;   // å¾…è§£ç é˜Ÿåˆ—
    std::deque<AudioTask> audio_playback_queue_; // å¾…æ’­æ”¾é˜Ÿåˆ—
};
```

### 7.2 éŸ³é¢‘è¾“å…¥ä»»åŠ¡

```cpp
// main/audio/audio_service.cc

void AudioService::AudioInputTask() {
    while (true) {
        // ç­‰å¾…äº‹ä»¶ï¼šå”¤é†’è¯æ£€æµ‹ æˆ– è¯­éŸ³å¤„ç†
        EventBits_t bits = xEventGroupWaitBits(event_group_,
            AS_EVENT_WAKE_WORD_RUNNING | AS_EVENT_AUDIO_PROCESSOR_RUNNING,
            pdFALSE, pdFALSE, portMAX_DELAY);
        
        // å”¤é†’è¯æ£€æµ‹æ¨¡å¼
        if (bits & AS_EVENT_WAKE_WORD_RUNNING) {
            std::vector<int16_t> data;
            int samples = wake_word_->GetFeedSize();  // è·å–éœ€è¦çš„æ ·æœ¬æ•°
            
            if (ReadAudioData(data, 16000, samples)) {
                wake_word_->Feed(data);  // å–‚ç»™å”¤é†’è¯æ£€æµ‹å™¨
            }
        }
        
        // è¯­éŸ³å¤„ç†æ¨¡å¼ï¼ˆå¯¹è¯ä¸­ï¼‰
        if (bits & AS_EVENT_AUDIO_PROCESSOR_RUNNING) {
            std::vector<int16_t> data;
            int samples = audio_processor_->GetFeedSize();
            
            if (ReadAudioData(data, 16000, samples)) {
                audio_processor_->Feed(std::move(data));  // å–‚ç»™ AFE
            }
        }
    }
}
```

### 7.3 AFE å¤„ç†ä»»åŠ¡

```cpp
// main/audio/processors/afe_audio_processor.cc

void AfeAudioProcessor::AudioProcessorTask() {
    auto fetch_size = afe_iface_->get_fetch_chunksize(afe_data_);
    
    while (true) {
        // ç­‰å¾…å¤„ç†å™¨è¿è¡Œ
        xEventGroupWaitBits(event_group_, PROCESSOR_RUNNING, 
                           pdFALSE, pdTRUE, portMAX_DELAY);
        
        // ä» AFE è·å–å¤„ç†åçš„æ•°æ®
        auto res = afe_iface_->fetch_with_delay(afe_data_, portMAX_DELAY);
        
        if (res == nullptr || res->ret_value == ESP_FAIL) {
            continue;
        }
        
        // VAD çŠ¶æ€å˜åŒ–æ£€æµ‹
        if (res->vad_state == VAD_SPEECH && !is_speaking_) {
            is_speaking_ = true;
            vad_state_change_callback_(true);   // å¼€å§‹è¯´è¯
        } else if (res->vad_state == VAD_SILENCE && is_speaking_) {
            is_speaking_ = false;
            vad_state_change_callback_(false);  // åœæ­¢è¯´è¯
        }
        
        // è¾“å‡ºå¤„ç†åçš„éŸ³é¢‘
        if (output_callback_) {
            output_buffer_.insert(output_buffer_.end(), 
                                 res->data, res->data + samples);
            
            // å‡‘å¤Ÿä¸€å¸§å°±è¾“å‡º
            while (output_buffer_.size() >= frame_samples_) {
                output_callback_(std::move(output_buffer_));
                output_buffer_.clear();
            }
        }
    }
}
```

### 7.4 Feed å’Œ Fetch æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AFE Feed/Fetch æœºåˆ¶                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   AudioInputTask                    AFE å†…éƒ¨                    â”‚
â”‚        â”‚                              â”‚                         â”‚
â”‚        â”‚  Feed(data)                  â”‚                         â”‚
â”‚        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚                         â”‚
â”‚        â”‚                              â”‚ ç¯å½¢ç¼“å†²åŒº               â”‚
â”‚        â”‚                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚        â”‚                              â”‚ â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚         â”‚
â”‚        â”‚                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚        â”‚                              â”‚       â”‚                 â”‚
â”‚        â”‚                              â”‚       â†“ å¤„ç†            â”‚
â”‚        â”‚                              â”‚  AEC â†’ NS â†’ VAD         â”‚
â”‚        â”‚                              â”‚       â”‚                 â”‚
â”‚        â”‚                              â”‚       â†“                 â”‚
â”‚        â”‚                    Fetch()   â”‚                         â”‚
â”‚   AudioProcessorTask â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  è¿”å›å¤„ç†åçš„æ•°æ®        â”‚
â”‚        â”‚                              â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Feed: å–‚å…¥åŸå§‹éŸ³é¢‘æ•°æ®ï¼ˆéº¦å…‹é£ + å‚è€ƒï¼‰
Fetch: è·å–å¤„ç†åçš„å¹²å‡€éŸ³é¢‘
```


### 7.5 å…³é”®æ•°æ®ç»“æ„

```cpp
// AFE å¤„ç†ç»“æœ
typedef struct {
    int16_t* data;           // å¤„ç†åçš„éŸ³é¢‘æ•°æ®
    int data_size;           // æ•°æ®å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    vad_state_t vad_state;   // VAD çŠ¶æ€ (SILENCE/SPEECH)
    int ret_value;           // è¿”å›å€¼ (ESP_OK/ESP_FAIL)
    int wakeup_state;        // å”¤é†’è¯çŠ¶æ€
    int wakenet_model_index; // å”¤é†’è¯æ¨¡å‹ç´¢å¼•
} afe_fetch_result_t;

// éŸ³é¢‘ä»»åŠ¡ç±»å‹
enum AudioTaskType {
    kAudioTaskTypeEncodeToSendQueue,    // ç¼–ç åå‘é€åˆ°æœåŠ¡å™¨
    kAudioTaskTypeEncodeToTestingQueue, // ç¼–ç åç”¨äºæµ‹è¯•
    kAudioTaskTypeDecodeToPlaybackQueue // è§£ç åæ’­æ”¾
};

// éŸ³é¢‘æµæ•°æ®åŒ…
struct AudioStreamPacket {
    int sample_rate;              // é‡‡æ ·ç‡
    int frame_duration;           // å¸§æ—¶é•¿ (ms)
    int64_t timestamp;            // æ—¶é—´æˆ³
    std::vector<uint8_t> payload; // Opus ç¼–ç æ•°æ®
};
```

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 CPU è´Ÿè½½åˆ†é…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Otto æœºå™¨äºº CPU è´Ÿè½½åˆ†é…                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  CPU 0 (è´Ÿè½½è¾ƒé‡)                CPU 1 (è´Ÿè½½è¾ƒè½»)                â”‚
â”‚  â”œâ”€â”€ audio_input (ä¼˜å…ˆçº§ 8)      â”œâ”€â”€ audio_output (ä¼˜å…ˆçº§ 4)    â”‚
â”‚  â”œâ”€â”€ å›¾å½¢æ¸²æŸ“ (LVGL)             â”œâ”€â”€ AFE å¤„ç† (ä¼˜å…ˆçº§ 4)        â”‚
â”‚  â””â”€â”€ WiFi åè®®æ ˆ                 â”œâ”€â”€ audio_communication        â”‚
â”‚                                  â””â”€â”€ Opus ç¼–è§£ç                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é…ç½®ä»£ç ï¼š
afe_config->afe_perferred_core = 1;      // AFE å›ºå®šåˆ° CPU1
afe_config->afe_perferred_priority = 4;  // ä¼˜å…ˆçº§ 4
```

### 8.2 å†…å­˜ä¼˜åŒ–

```cpp
// ä½¿ç”¨ PSRAM å­˜å‚¨å¤§æ•°æ®
afe_config->memory_alloc_mode = AFE_MEMORY_ALLOC_MORE_PSRAM;

// å¢å¤§ç¯å½¢ç¼“å†²åŒºï¼Œé¿å…æ•°æ®ä¸¢å¤±
afe_config->afe_ringbuf_size = 1000;  // ç¥ç»ç½‘ç»œ VAD éœ€è¦æ›´å¤§ç¼“å†²
```

### 8.3 åŠŸè€—ä¼˜åŒ–

```cpp
// éŸ³é¢‘ç©ºé—²æ—¶è‡ªåŠ¨å…³é—­
void AudioService::CheckAndUpdateAudioPowerState() {
    auto now = std::chrono::steady_clock::now();
    
    // è¶…è¿‡ 5 ç§’æ²¡æœ‰è¾“å…¥ï¼Œå…³é—­éº¦å…‹é£
    if (input_elapsed > AUDIO_POWER_TIMEOUT_MS && codec_->input_enabled()) {
        codec_->EnableInput(false);
    }
    
    // è¶…è¿‡ 5 ç§’æ²¡æœ‰è¾“å‡ºï¼Œå…³é—­æ‰¬å£°å™¨
    if (output_elapsed > AUDIO_POWER_TIMEOUT_MS && codec_->output_enabled()) {
        codec_->EnableOutput(false);
    }
}
```

---

## 9. å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦ 32 ä½è½¬ 16 ä½ï¼Ÿ

INMP441 éº¦å…‹é£è¾“å‡º 32 ä½æ•°æ®ï¼Œä½†æœ‰æ•ˆæ•°æ®åªæœ‰é«˜ 24 ä½ã€‚
ä¸ºäº†èŠ‚çœå†…å­˜å’Œå¸¦å®½ï¼Œè½¬æ¢ä¸º 16 ä½ï¼š

```cpp
int32_t value = bit32_buffer[i] >> 12;  // å³ç§» 12 ä½
dest[i] = (int16_t)value;               // æˆªæ–­ä¸º 16 ä½
```

### Q2: AEC å»¶è¿Ÿæ€ä¹ˆè®¾ç½®ï¼Ÿ

å£°éŸ³ä»æ‰¬å£°å™¨æ’­æ”¾åˆ°è¢«éº¦å…‹é£é‡‡é›†æœ‰å»¶è¿Ÿï¼Œéœ€è¦å¯¹é½ï¼š

```cpp
// å‚è€ƒä¿¡å·å»¶è¿Ÿï¼ˆæ ¹æ®å®é™…ç¡¬ä»¶è°ƒæ•´ï¼‰
static constexpr size_t kAecDelaySamples = 160;  // 10ms @ 16kHz
```

### Q3: ä¸ºä»€ä¹ˆç”¨ç¥ç»ç½‘ç»œé™å™ªï¼Ÿ

| å¯¹æ¯” | WebRTC NS | NSNet (ç¥ç»ç½‘ç»œ) |
|------|-----------|-----------------|
| æ•ˆæœ | ä¸€èˆ¬ | ä¼˜ç§€ |
| CPU | ä½ | é«˜ |
| é€‚ç”¨ | ç®€å•å™ªéŸ³ | å¤æ‚å™ªéŸ³ |

Otto ä½¿ç”¨ NSNet2 ç¥ç»ç½‘ç»œé™å™ªï¼Œæ•ˆæœæ›´å¥½ã€‚

### Q4: VAD çµæ•åº¦æ€ä¹ˆè°ƒï¼Ÿ

```cpp
afe_config->vad_mode = VAD_MODE_3;  // 0-3ï¼Œè¶Šå¤§è¶Šçµæ•

// VAD_MODE_0: æœ€ä¸çµæ•ï¼Œé€‚åˆå®‰é™ç¯å¢ƒ
// VAD_MODE_3: æœ€çµæ•ï¼Œé€‚åˆå˜ˆæ‚ç¯å¢ƒ
```

---

## 10. æ€»ç»“

### 10.1 æ ¸å¿ƒæµç¨‹

```
éº¦å…‹é£ â†’ I2S â†’ AudioCodec.Read() â†’ AFE.Feed() â†’ AFE.Fetch() â†’ å¹²å‡€éŸ³é¢‘
                     â†‘
              å‚è€ƒä¿¡å·ï¼ˆAECï¼‰
```

### 10.2 å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `config.h` | ç¡¬ä»¶å¼•è„šé…ç½® |
| `no_audio_codec.cc` | I2S éŸ³é¢‘è¯»å†™ |
| `audio_service.cc` | éŸ³é¢‘æœåŠ¡ä¸»é€»è¾‘ |
| `afe_audio_processor.cc` | AFE å¤„ç†å™¨ |
| `afe_wake_word.cc` | å”¤é†’è¯æ£€æµ‹ |

### 10.3 ESP-SR æ¨¡å‹

| æ¨¡å‹ | ä½œç”¨ |
|------|------|
| WakeNet | å”¤é†’è¯æ£€æµ‹ |
| NSNet2 | ç¥ç»ç½‘ç»œé™å™ª |
| VADNet1 | ç¥ç»ç½‘ç»œè¯­éŸ³æ£€æµ‹ |

---

## å‚è€ƒèµ„æ–™

- [ESP-IDF I2S æ–‡æ¡£](https://docs.espressif.com/projects/esp-idf/en/latest/esp32s3/api-reference/peripherals/i2s.html)
- [ESP-SR è¯­éŸ³è¯†åˆ«æ¡†æ¶](https://github.com/espressif/esp-sr)
- [INMP441 æ•°æ®æ‰‹å†Œ](https://invensense.tdk.com/products/digital/inmp441/)
- [MAX98357A æ•°æ®æ‰‹å†Œ](https://www.maximintegrated.com/en/products/analog/audio/MAX98357A.html)
