# âš ï¸ CPU è¿‡è½½é—®é¢˜ä¿®å¤

## ğŸ”´ é‡åˆ°çš„é—®é¢˜

### é”™è¯¯ç°è±¡

```
Guru Meditation Error: Core 0 panic'ed (Interrupt wdt timeout on CPU0)
E BOD: Brownout detector was triggered
```

æœºå™¨äººåå¤é‡å¯ï¼Œç³»ç»Ÿå´©æºƒã€‚

---

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜åˆ†æ

å¯ç”¨é™å™ªåçš„æ—¥å¿—ï¼š
```
I (6332) AfeWakeWord: å”¤é†’è¯æ£€æµ‹: ä½¿ç”¨ WebRTC é™å™ªï¼ˆæ— éœ€æ¨¡å‹ï¼‰
I (6412) AFE: AFE Pipeline: |NS(WebRTC)| -> |VAD(WebRTC)| -> |WakeNet(...)| 
Guru Meditation Error: Core 0 panic'ed (Interrupt wdt timeout on CPU0)
```

**CPU0 åŒæ—¶è¿è¡Œ**ï¼š
1. âœ… WiFi é©±åŠ¨ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
2. âœ… LVGL å›¾å½¢æ˜¾ç¤º
3. âœ… WakeNet å”¤é†’è¯æ£€æµ‹ï¼ˆæŒç»­è¿è¡Œï¼‰
4. âŒ **WebRTC é™å™ª**ï¼ˆæ–°å¢ï¼ŒCPU å¯†é›†ï¼‰
5. âœ… VAD è¯­éŸ³æ´»åŠ¨æ£€æµ‹
6. âœ… Otto æœºå™¨äººæ§åˆ¶

**ç»“æœ**ï¼š
- ä¸­æ–­å“åº”æ—¶é—´è¿‡é•¿ â†’ çœ‹é—¨ç‹—è¶…æ—¶
- åŠŸè€—æ¿€å¢ â†’ ç”µæºæ¬ å‹ï¼ˆBODï¼‰
- ç³»ç»Ÿå´©æºƒé‡å¯

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ç­–ç•¥ï¼šåˆ†é˜¶æ®µå¯ç”¨é™å™ª

| é˜¶æ®µ | çŠ¶æ€ | é™å™ª | åŸå›  |
|------|------|------|------|
| **å”¤é†’è¯æ£€æµ‹** | æŒç»­è¿è¡Œ | âŒ **ç¦ç”¨** | é¿å…æŒç»­å ç”¨ CPU |
| **è¯­éŸ³è¯†åˆ«** | æŒ‰éœ€å¯åŠ¨ï¼ˆè¯´è¯æ—¶ï¼‰ | âœ… **å¯ç”¨** | çŸ­æ—¶è¿è¡Œï¼Œæé«˜è¯†åˆ«ç‡ |

### ä¿®æ”¹ 1ï¼šç¦ç”¨å”¤é†’è¯é˜¶æ®µçš„é™å™ª

**æ–‡ä»¶**ï¼š`main/audio/wake_words/afe_wake_word.cc`

```cpp
// ä¹‹å‰ï¼šå¯ç”¨é™å™ª â†’ CPU è¿‡è½½
afe_config->ns_init = true;
afe_config->afe_ns_mode = AFE_NS_MODE_WEBRTC;

// ç°åœ¨ï¼šç¦ç”¨é™å™ª â†’ ç³»ç»Ÿç¨³å®š
// å”¤é†’è¯æ£€æµ‹é˜¶æ®µä¸å¯ç”¨é™å™ªï¼Œé¿å… CPU è¿‡è½½
ESP_LOGI(TAG, "å”¤é†’è¯æ£€æµ‹: é™å™ªå·²ç¦ç”¨ï¼ˆé¿å…CPUè¿‡è½½ï¼‰");
```

### ä¿®æ”¹ 2ï¼šé™ä½æ€§èƒ½æ¨¡å¼

**æ–‡ä»¶**ï¼š`main/audio/processors/afe_audio_processor.cc`

```cpp
// ä¹‹å‰ï¼šé«˜æ€§èƒ½æ¨¡å¼ â†’ CPU å ç”¨é«˜
afe_config_t* afe_config = afe_config_init(..., AFE_MODE_HIGH_PERF);
afe_config->aec_mode = AEC_MODE_VOIP_HIGH_PERF;

// ç°åœ¨ï¼šæ™®é€šæ¨¡å¼ â†’ CPU å ç”¨ä½
afe_config_t* afe_config = afe_config_init(..., AFE_MODE_NORMAL);
afe_config->aec_mode = AEC_MODE_VOIP_NORMAL;
```

### ä¿®æ”¹ 3ï¼šä¿ç•™è¯­éŸ³è¯†åˆ«é˜¶æ®µçš„é™å™ª

**æ–‡ä»¶**ï¼š`main/audio/processors/afe_audio_processor.cc`

```cpp
// è¯­éŸ³è¯†åˆ«æ—¶ï¼ˆæŒ‰éœ€å¯åŠ¨ï¼‰
if (ns_model_name != nullptr) {
    afe_config->ns_init = true;
    afe_config->afe_ns_mode = AFE_NS_MODE_NET;
    ESP_LOGI(TAG, "ä½¿ç”¨ç¥ç»ç½‘ç»œé™å™ªæ¨¡å‹: %s", ns_model_name);
} else {
    // WebRTC é™å™ªï¼ˆæ— éœ€æ¨¡å‹ï¼‰
    afe_config->ns_init = true;
    afe_config->afe_ns_mode = AFE_NS_MODE_WEBRTC;
    ESP_LOGI(TAG, "ä½¿ç”¨ WebRTC é™å™ªï¼ˆæ— éœ€æ¨¡å‹ï¼‰");
}
```

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### å¯åŠ¨æ—¥å¿—

```
I (xxxx) AfeWakeWord: å”¤é†’è¯æ£€æµ‹: é™å™ªå·²ç¦ç”¨ï¼ˆé¿å…CPUè¿‡è½½ï¼‰
I (xxxx) AFE: AFE Pipeline: [input] -> |VAD(WebRTC)| -> |WakeNet(...)| -> [output]
                                        â†‘
                                   æ²¡æœ‰ NSï¼ŒCPU è´Ÿè½½æ­£å¸¸
```

### è¯´"ä½ å¥½å°æ™º"å

```
I (xxxx) AfeAudioProcessor: ä½¿ç”¨ WebRTC é™å™ªï¼ˆæ— éœ€æ¨¡å‹ï¼‰
I (xxxx) AFE: AFE Pipeline: [input] -> |NS(WebRTC)| -> |VAD(WebRTC)| -> [output]
                                        â†‘
                                   çŸ­æ—¶é—´å¯ç”¨é™å™ªï¼Œä¸å½±å“ç¨³å®šæ€§
```

### ç³»ç»ŸçŠ¶æ€

- âœ… ä¸å†å´©æºƒé‡å¯
- âœ… WiFi ç¨³å®šè¿æ¥
- âœ… æ˜¾ç¤ºæ­£å¸¸å·¥ä½œ
- âœ… å”¤é†’è¯æ­£å¸¸è¯†åˆ«
- âœ… è¯­éŸ³è¯†åˆ«æ—¶æœ‰é™å™ªæ”¹å–„

---

## ğŸš€ ç«‹å³æµ‹è¯•

```bash
cd /Users/machenyang/Desktop/xiaozhi-esp32-main
idf.py build flash monitor
```

### è§‚å¯Ÿè¦ç‚¹

#### 1. å¯åŠ¨æ—¶ - åº”è¯¥ç¨³å®š

```
I (xxxx) AfeWakeWord: å”¤é†’è¯æ£€æµ‹: é™å™ªå·²ç¦ç”¨ï¼ˆé¿å…CPUè¿‡è½½ï¼‰
I (xxxx) AFE: AFE Pipeline: ... -> |VAD(...)| -> |WakeNet(...)| -> ...
I (xxxx) Application: STATE: idle
```

**å…³é”®**ï¼šæ²¡æœ‰ `|NS(WebRTC)|`ï¼Œç³»ç»Ÿåº”è¯¥æ­£å¸¸è¿è¡Œï¼Œä¸å†é‡å¯ã€‚

#### 2. è¯´"ä½ å¥½å°æ™º"å - é™å™ªå¯åŠ¨

```
I (xxxx) Application: Wake word detected: ä½ å¥½å°æ™º
I (xxxx) AfeAudioProcessor: ä½¿ç”¨ WebRTC é™å™ªï¼ˆæ— éœ€æ¨¡å‹ï¼‰
I (xxxx) AFE: AFE Pipeline: ... -> |NS(WebRTC)| -> |VAD(...)| -> ...
```

**å…³é”®**ï¼šé™å™ªåªåœ¨è¯´è¯æ—¶å¯åŠ¨ï¼ŒçŸ­æ—¶é—´è¿è¡Œã€‚

#### 3. æ²¡æœ‰é”™è¯¯

- âŒ ä¸åº”è¯¥çœ‹åˆ° `Guru Meditation Error`
- âŒ ä¸åº”è¯¥çœ‹åˆ° `Brownout detector`
- âŒ ä¸åº”è¯¥åå¤é‡å¯

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆå´©æºƒï¼‰

| ç»„ä»¶ | CPU å ç”¨ | çŠ¶æ€ |
|------|---------|------|
| WiFi | ä¸­ | âœ… è¿è¡Œ |
| LVGL æ˜¾ç¤º | é«˜ | âœ… è¿è¡Œ |
| WakeNet | é«˜ | âœ… æŒç»­è¿è¡Œ |
| **é™å™ª** | **é«˜** | âŒ **æŒç»­è¿è¡Œ** |
| VAD | ä¸­ | âœ… è¿è¡Œ |
| **æ€»è®¡** | **è¶…è½½** | âŒ **å´©æºƒ** |

### ä¿®æ”¹åï¼ˆç¨³å®šï¼‰

| ç»„ä»¶ | CPU å ç”¨ | çŠ¶æ€ |
|------|---------|------|
| WiFi | ä¸­ | âœ… è¿è¡Œ |
| LVGL æ˜¾ç¤º | é«˜ | âœ… è¿è¡Œ |
| WakeNet | ä¸­ï¼ˆæ™®é€šæ¨¡å¼ï¼‰ | âœ… æŒç»­è¿è¡Œ |
| **é™å™ª** | **0** | âœ… **å¾…æœº** |
| VAD | ä¸­ | âœ… è¿è¡Œ |
| **æ€»è®¡** | **æ­£å¸¸** | âœ… **ç¨³å®š** |

### è¯­éŸ³è¯†åˆ«æ—¶ï¼ˆçŸ­æ—¶é—´ï¼‰

| ç»„ä»¶ | CPU å ç”¨ | çŠ¶æ€ |
|------|---------|------|
| WiFi | ä¸­ | âœ… è¿è¡Œ |
| LVGL æ˜¾ç¤º | é«˜ | âœ… è¿è¡Œ |
| WakeNet | 0ï¼ˆå·²åœæ­¢ï¼‰ | â¸ï¸ æš‚åœ |
| **é™å™ª** | **é«˜** | âœ… **çŸ­æ—¶è¿è¡Œï¼ˆå‡ ç§’ï¼‰** |
| VAD | ä¸­ | âœ… è¿è¡Œ |
| **æ€»è®¡** | **å¯æ¥å—** | âœ… **ç¨³å®š** |

---

## ğŸ’¡ é™å™ªæ•ˆæœé¢„æœŸ

### å”¤é†’è¯æ£€æµ‹é˜¶æ®µ

- **ç¯å¢ƒ**ï¼šå®‰é™æˆ–è½»åº¦å™ªéŸ³
- **é™å™ª**ï¼šæ— 
- **è¯†åˆ«ç‡**ï¼šWakeNet æ¨¡å‹æœ¬èº«æœ‰ä¸€å®šæŠ—å™ªèƒ½åŠ›
- **å»ºè®®**ï¼šåœ¨ç›¸å¯¹å®‰é™çš„ç¯å¢ƒä½¿ç”¨å”¤é†’è¯

### è¯­éŸ³è¯†åˆ«é˜¶æ®µ

- **ç¯å¢ƒ**ï¼šå„ç§å™ªéŸ³
- **é™å™ª**ï¼šâœ… WebRTC é™å™ª
- **è¯†åˆ«ç‡**ï¼šâœ… æ˜æ˜¾æ”¹å–„
- **æ•ˆæœ**ï¼š
  - âœ… æŠ‘åˆ¶é£æ‰‡ã€ç©ºè°ƒç­‰ç¨³æ€å™ªéŸ³
  - âœ… æé«˜è¯­éŸ³æ¸…æ™°åº¦
  - âœ… å‡å°‘è¯†åˆ«é”™è¯¯

---

## ğŸ”§ è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### é€‰é¡¹ 1ï¼šå¦‚æœä»ç„¶å´©æºƒ

é™ä½ LVGL æ˜¾ç¤ºåˆ·æ–°ç‡ï¼š

```cpp
// é™ä½æ˜¾ç¤ºæ›´æ–°é¢‘ç‡
lv_display_set_default_refresh_rate(display, 30);  // ä» 60fps é™åˆ° 30fps
```

### é€‰é¡¹ 2ï¼šå¦‚æœç”µæºé—®é¢˜æŒç»­

æ£€æŸ¥ç¡¬ä»¶ï¼š
- ä½¿ç”¨æ›´å¤§åŠŸç‡çš„ç”µæºé€‚é…å™¨ï¼ˆå»ºè®® 5V 2A æˆ–æ›´é«˜ï¼‰
- æ£€æŸ¥ USB çº¿ç¼†è´¨é‡
- æ£€æŸ¥ä¾›ç”µç¨³å®šæ€§

### é€‰é¡¹ 3ï¼šå¦‚æœéœ€è¦æ›´å¥½çš„å”¤é†’è¯è¯†åˆ«

ä¸å¯ç”¨é™å™ªï¼Œæ”¹ä¸ºï¼š
- æé«˜éº¦å…‹é£å¢ç›Š
- æ”¹å–„éº¦å…‹é£ä½ç½®
- å‡å°‘ç¯å¢ƒå™ªéŸ³æº

### é€‰é¡¹ 4ï¼šå¦‚æœè¯­éŸ³è¯†åˆ«æ•ˆæœä¸ç†æƒ³

è€ƒè™‘æ·»åŠ ç¥ç»ç½‘ç»œé™å™ªæ¨¡å‹ï¼ˆéœ€è¦é¢å¤–çš„æ¨¡å‹æ–‡ä»¶ï¼‰ï¼š
- æ¨¡å‹åç§°ï¼š`nsnet3_ch1.bin`
- æ•ˆæœæ›´å¥½ï¼Œä½†èµ„æºå ç”¨ç•¥é«˜
- éœ€è¦æ‰“åŒ…åˆ° `srmodels.bin` ä¸­

---

## ğŸ‰ æ€»ç»“

### é—®é¢˜

- âŒ åŒæ—¶å¯ç”¨å¤ªå¤š CPU å¯†é›†ä»»åŠ¡å¯¼è‡´å´©æºƒ
- âŒ ç”µæºæ¬ å‹ï¼ˆBODï¼‰

### è§£å†³

- âœ… ç¦ç”¨å”¤é†’è¯é˜¶æ®µçš„é™å™ªï¼ˆæŒç»­è¿è¡Œï¼‰
- âœ… é™ä½æ€§èƒ½æ¨¡å¼ï¼ˆNORMAL ä»£æ›¿ HIGH_PERFï¼‰
- âœ… ä¿ç•™è¯­éŸ³è¯†åˆ«é˜¶æ®µçš„é™å™ªï¼ˆæŒ‰éœ€å¯åŠ¨ï¼‰

### æ•ˆæœ

- âœ… ç³»ç»Ÿç¨³å®šï¼Œä¸å†å´©æºƒ
- âœ… å”¤é†’è¯æ­£å¸¸å·¥ä½œ
- âœ… è¯­éŸ³è¯†åˆ«æ—¶æœ‰é™å™ªæ”¹å–„
- âœ… åŠŸè€—é™ä½ï¼Œç”µæºç¨³å®š

---

## ğŸš¦ æˆåŠŸæ ‡å¿—

ç¼–è¯‘çƒ§å½•åï¼Œå¦‚æœçœ‹åˆ°ï¼š

```
I (xxxx) AfeWakeWord: å”¤é†’è¯æ£€æµ‹: é™å™ªå·²ç¦ç”¨ï¼ˆé¿å…CPUè¿‡è½½ï¼‰
I (xxxx) AFE: AFE Pipeline: [input] -> |VAD(WebRTC)| -> |WakeNet(...)| -> [output]
I (xxxx) Application: STATE: idle
```

å¹¶ä¸”ç³»ç»Ÿ**ä¸å†é‡å¯**ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸï¼ ğŸ‰

---

**ç°åœ¨ç¼–è¯‘æµ‹è¯•ï¼** ğŸš€

```bash
idf.py build flash monitor
```



