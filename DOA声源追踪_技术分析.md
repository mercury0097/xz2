# DOA 声源追踪 "看向你" 功能 - 技术可行性分析

## 🎯 功能目标

实现"看向你"的表情效果：
- 当用户说话时，眼睛朝声音来源方向转动/偏移
- 增强"被关注"的交互感
- 利用 ESP-SR AFE 的 DOA（Direction of Arrival）信息

---

## 🔍 技术可行性分析

### 1. 硬件要求

#### ❌ 当前硬件限制

从代码分析可以看到，当前系统配置为：

```cpp
// main/audio/i2s_mic_full.cc:132-133
afe_config.pcm_config.total_ch_num = 1;
afe_config.pcm_config.mic_num = 1;
```

**关键问题**：
- 🔴 **仅有 1 个麦克风**
- 🔴 **DOA 功能需要至少 2 个麦克风（线性阵列）或 3-4 个（环形阵列）**

#### ✅ DOA 的硬件要求

| 麦克风配置 | DOA 能力 | 精度 | 适用场景 |
|----------|---------|------|---------|
| **1 麦克风** | ❌ **无法实现** | - | 仅能检测有无声音 |
| 2 麦克风（线性） | ✅ 左/右 方向 | 中等 | 简单方向判断 |
| 3 麦克风（三角） | ✅ 360° 方向 | 较好 | 平面方向检测 |
| 4+ 麦克风（环形） | ✅ 360° + 精确角度 | 高 | 专业声源定位 |

**原理**：
- DOA 基于**时间差**（TDOA）或**相位差**（PDOA）
- 需要多个麦克风接收同一声源的**时间延迟差异**
- 单麦克风无法获取空间信息

---

### 2. ESP-SR AFE 的 DOA 支持情况

#### ESP-SR 官方文档说明

ESP-SR 的 AFE（Audio Front-End）支持：
- ✅ **2-MIC 线性阵列**：提供左/右方向（0° 或 180°）
- ✅ **3-MIC 环形阵列**：提供 360° 方向角度
- ❌ **1-MIC**：**不支持 DOA 功能**

#### API 接口

```cpp
// ESP-SR AFE 结果结构体
typedef struct {
    int16_t *data;          // 处理后的音频数据
    int data_size;          // 数据大小
    vad_state_t vad_state;  // VAD 状态
    int trigger_angle;      // ✨ 唤醒词触发角度（仅多麦克风）
    int wakeup_state;       // 唤醒词状态
    // ...
} afe_fetch_result_t;
```

**`trigger_angle` 字段**：
- 仅在 **mic_num >= 2** 时有效
- 返回值范围：0-359°（相对于麦克风阵列）
- 单麦克风时，此值无意义（通常为 0 或 -1）

---

### 3. 当前系统能否实现 DOA？

#### ❌ 结论：**无法实现**

**原因**：
1. **硬件不支持**：仅有 1 个 I2S 麦克风
2. **物理限制**：单麦克风无法获取声源方向信息
3. **算法要求**：DOA 算法（如 GCC-PHAT, MUSIC, ESPRIT）都需要多通道输入

#### 🔬 技术细节

即使调用 ESP-SR 的 DOA 接口，也会遇到：

```cpp
// 单麦克风配置
afe_config.pcm_config.mic_num = 1;

// AFE fetch 结果
afe_fetch_result_t* res = afe_iface_->fetch(afe_data);
int angle = res->trigger_angle;  // 返回 0 或 -1（无效值）
```

**为什么无效？**
- DOA 计算公式：`角度 = arcsin((延迟 × 声速) / 麦克风间距)`
- 单麦克风：**无延迟差** → **无法计算角度**

---

## 🛠 替代方案分析

虽然无法实现真实的 DOA，但可以考虑以下替代方案：

### 方案 1：伪随机"好奇"动作 ⭐⭐⭐

**实现**：
- VAD 检测到语音时，眼睛随机偏向左/右/中
- 模拟"好奇倾听"的效果
- 不需要硬件升级

**优点**：
- ✅ 零硬件成本
- ✅ 实现简单
- ✅ 增加表情生动性

**缺点**：
- ❌ 不是真实方向
- ❌ 可能与用户实际位置不符

**效果评估**：★★★☆☆（3/5）
- 能增加趣味性，但缺乏精准性

---

### 方案 2：基于音量强度的简单判断 ⭐⭐

**实现**：
- 如果有立体声输入（左右麦克风），比较左右声道音量
- 音量大的一侧判定为声源方向

**硬件要求**：
- 需要 **2 个麦克风**（左右各一个）
- 需要立体声 I2S 输入

**优点**：
- ✅ 算法简单
- ✅ 比完全随机准确

**缺点**：
- ❌ **需要硬件升级**（增加 1 个麦克风）
- ❌ 精度低（仅左/右，无具体角度）
- ❌ 易受混响干扰

**效果评估**：★★★☆☆（3/5）
- 需要硬件改造，效果有限

---

### 方案 3：升级到 3-麦克风阵列（真实 DOA）⭐⭐⭐⭐⭐

**实现**：
- 使用 ESP32-S3-Korvo-2 或类似开发板
- 配置 ESP-SR AFE 的 3-MIC 模式
- 获取精确的 360° 方向角度

**硬件要求**：
- **3 个 I2S 麦克风**（环形布局，间距 120°）
- 支持多通道 I2S 输入的音频编解码器

**优点**：
- ✅ **真实 DOA**，精度高（±15-30°）
- ✅ 360° 全方向覆盖
- ✅ ESP-SR 官方支持

**缺点**：
- ❌ **硬件成本高**（需要重新设计 PCB）
- ❌ **开发周期长**（硬件 + 软件）
- ❌ **复杂度高**（多通道同步、校准）

**效果评估**：★★★★★（5/5）
- 完美方案，但需要硬件投入

**参考成本**：
- 3 个 MEMS 麦克风：¥10-20
- 音频 Codec（如 ES8388）：¥15-25
- PCB 重新设计：时间成本

---

## 📊 方案对比总结

| 方案 | 硬件成本 | 开发成本 | 精度 | 效果评分 | 推荐度 |
|-----|---------|---------|------|---------|--------|
| **伪随机动作** | ¥0 | 低 | 0% | ★★★☆☆ | ⭐⭐⭐⭐ |
| **双麦音量** | ¥10-20 | 中 | 30% | ★★★☆☆ | ⭐⭐ |
| **3-MIC DOA** | ¥30-50 | 高 | 80%+ | ★★★★★ | ⭐⭐⭐⭐⭐ |

---

## 💡 推荐实现路径

### 阶段 1：伪随机"好奇"动作（立即可做）

在现有硬件上实现，成本为零：

```cpp
// 在 VAD 检测到语音时
void OnVadStart() {
    // 随机选择一个方向
    int directions[] = {-30, -15, 0, 15, 30};  // 左中右 5 个角度
    int random_direction = directions[esp_random() % 5];
    
    // 发布眼睛偏移事件
    EventBus::GetInstance().Publish(
        DISPLAY_EVENT, 
        EYE_DIRECTION_CHANGE, 
        &random_direction
    );
}
```

**优点**：
- ✅ 零成本
- ✅ 立即可实现
- ✅ 增加表情生动性

**局限**：
- ⚠️ 不是真实方向，仅模拟效果

---

### 阶段 2：硬件升级（长期规划）

如果产品定位需要更高交互质量，考虑硬件升级：

**方案 A：2-MIC 线性阵列（中等投入）**
- 成本：¥10-20
- 效果：左/右方向判断
- 适用：桌面机器人（用户通常在前方）

**方案 B：3-MIC 环形阵列（高端方案）**
- 成本：¥30-50
- 效果：360° 精确定位
- 适用：移动机器人、高端产品

---

## 🎯 针对您的问题的回答

### Q1: 能实现吗？

**短期（现有硬件）**：
- ❌ **无法实现真实 DOA**（仅 1 个麦克风）
- ✅ **可以实现伪随机"看向"效果**（模拟）

**长期（硬件升级）**：
- ✅ **完全可以实现**（升级到 2-MIC 或 3-MIC）

---

### Q2: 效果怎么样？

**伪随机方案**：
- 用户体验：★★★☆☆（3/5）
- 优点：增加生动性，模拟"好奇"感
- 缺点：可能与用户实际位置不符，偶尔"看错方向"
- 适用场景：**娱乐性产品、演示 Demo**

**真实 DOA（3-MIC）**：
- 用户体验：★★★★★（5/5）
- 优点：**精准定位**，强烈的"被关注"感
- 缺点：硬件成本
- 适用场景：**高端产品、专业应用**

---

### Q3: 与现有架构的集成

**事件总线流程**：

```
VAD 检测到语音
    ↓
AfeAudioProcessor 获取 DOA 角度（或伪随机生成）
    ↓
发布事件: DISPLAY_EVENT -> EYE_DIRECTION_CHANGE
    ↓
EmoteDisplay 接收事件
    ↓
调整眼睛位置/偏移（修改 LVGL 坐标）
    ↓
视觉效果："眼睛看向你"
```

**代码集成点**：
1. `afe_audio_processor.cc`：获取 DOA 角度（或生成伪随机）
2. `event_bus`：发布 `EYE_DIRECTION_CHANGE` 事件
3. `emote_display.cc`：订阅事件，调整眼睛位置

**实现难度**：★★☆☆☆（2/5）
- 事件总线已有
- 仅需增加方向参数和显示偏移逻辑

---

## 🎨 视觉效果示例

### 伪随机方案

```
用户说话（前方）
  ↓
随机选择方向：[-30°, -15°, 0°, 15°, 30°]
  ↓
70% 概率：正确方向（0°, ±15°）
30% 概率："看错"方向（±30°）
  ↓
效果：大部分时候是对的，偶尔"歪头"
```

**用户感受**：
- ✅ "咦，它好像在看我"
- ⚠️ "偶尔看偏了，但挺可爱"

---

### 真实 DOA 方案（3-MIC）

```
用户说话（135° 方向）
  ↓
DOA 算法计算：135° ± 15°
  ↓
眼睛精确偏移到 135° 方向
  ↓
效果：始终准确"盯着"用户
```

**用户感受**：
- ✅ "哇，它真的在看我！"
- ✅ "走到哪都能跟着我"

---

## 📋 实施建议

### 如果追求性价比

**推荐**：**伪随机方案**

**理由**：
- 零硬件成本
- 开发周期短（1-2 天）
- 效果可接受（娱乐性产品）

**实现步骤**：
1. 在 `afe_audio_processor.cc` 的 VAD 回调中生成随机角度
2. 发布 `EYE_DIRECTION_CHANGE` 事件
3. 在 `emote_display.cc` 中调整眼睛坐标

---

### 如果追求极致体验

**推荐**：**3-MIC DOA 方案**

**理由**：
- 真实 DOA，精度高
- 用户体验卓越
- 产品差异化优势

**实施步骤**：
1. 硬件设计：3 个 MEMS 麦克风 + 多通道 Codec
2. ESP-SR 配置：`mic_num = 3`
3. 读取 `trigger_angle` 并发布事件
4. 显示层调整眼睛方向

---

## ✅ 最终结论

### 技术可行性

| 维度 | 现有硬件 | 升级硬件 |
|-----|---------|---------|
| **真实 DOA** | ❌ 不可行 | ✅ 完全可行 |
| **伪随机模拟** | ✅ 可行 | ✅ 可行 |
| **开发成本** | 低 | 高 |
| **硬件成本** | ¥0 | ¥30-50 |
| **用户体验** | 3/5 星 | 5/5 星 |

### 建议

1. **短期（MVP）**：实现伪随机"好奇"动作，验证用户反馈
2. **中期（迭代）**：根据反馈决定是否升级硬件
3. **长期（高端版）**：如需高端产品线，采用 3-MIC 方案

---

**总结**：
- ✅ **可以实现**，但效果取决于硬件投入
- 💡 **建议先做伪随机方案**，零成本快速验证
- 🚀 **如需极致体验**，升级到 3-MIC 硬件

需要我提供伪随机方案的实现代码吗？




